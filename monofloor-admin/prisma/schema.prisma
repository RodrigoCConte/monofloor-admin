generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// ADMIN USERS (Usuários do painel admin)
// =============================================
model AdminUser {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  role          AdminRole @default(ADMIN)
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  approvedUsers         User[]              @relation("ApprovedByAdmin")
  promotedUsers         User[]              @relation("PromotedByAdmin")
  projectAssignments    ProjectAssignment[] @relation("AssignedByAdmin")
  uploadedDocuments     ProjectDocument[]
  generatedReports      GeneratedReport[]
  auditLogs             AuditLog[]
  nightShiftInvites     NightShiftInvite[]
  reviewedContributions ContributionRequest[]
  resolvedHelpRequests  HelpRequest[]
  notifications         Notification[]

  @@map("admin_users")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

// =============================================
// USERS / APLICADORES
// =============================================
model User {
  id              String     @id @default(uuid())
  email           String     @unique
  passwordHash    String     @map("password_hash")
  name            String
  username        String     @unique
  phone           String?
  cpf             String?    @unique
  photoUrl        String?    @map("photo_url")
  documentUrl     String?    @map("document_url")

  // Approval workflow
  status          UserStatus @default(PENDING_APPROVAL)
  approvedAt      DateTime?  @map("approved_at")
  approvedById    String?    @map("approved_by")
  approvedBy      AdminUser? @relation("ApprovedByAdmin", fields: [approvedById], references: [id])
  rejectionReason String?    @map("rejection_reason")

  // Role/Position (managed by admin)
  role            UserRole   @default(AUXILIAR)
  promotedAt      DateTime?  @map("promoted_at")
  promotedById    String?    @map("promoted_by")
  promotedBy      AdminUser? @relation("PromotedByAdmin", fields: [promotedById], references: [id])

  // Gamification
  xpTotal         Int        @default(0) @map("xp_total")
  level           Int        @default(1)

  // Statistics (denormalized for performance)
  totalHoursWorked  Decimal  @default(0) @map("total_hours_worked") @db.Decimal(10, 2)
  totalM2Applied    Decimal  @default(0) @map("total_m2_applied") @db.Decimal(10, 2)
  totalProjectsCount Int     @default(0) @map("total_projects_count")

  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relations
  projectAssignments    ProjectAssignment[]
  checkins              Checkin[]
  reports               Report[]
  auditLogs             AuditLog[]
  location              UserLocation?
  locationHistory       LocationHistory[]
  nightShiftInvites     NightShiftInvite[]
  contributionRequests  ContributionRequest[]
  helpRequests          HelpRequest[]
  pushSubscriptions     PushSubscription[]
  xpTransactions        XpTransaction[]
  campaignParticipations CampaignParticipant[]
  campaignWins          CampaignWinner[]
  badges                UserBadge[]
  feedPosts             FeedPost[]
  feedPostLikes         FeedPostLike[]
  feedPostComments      FeedPostComment[]
  notificationViews     NotificationView[]

  @@map("users")
}

enum UserStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SUSPENDED
}

enum UserRole {
  // Hierarquia de Aplicação (do maior para menor)
  LIDER              // Líder da equipe de aplicação
  APLICADOR          // Aplicador principal
  APLICADOR_AUX      // Aplicador auxiliar

  // Hierarquia de Preparação
  LIDER_PREPARACAO   // Líder de preparação
  PREPARADOR         // Preparador

  // Base
  AUXILIAR           // Auxiliar geral
}

// =============================================
// PROJECTS (Synced from Pipefy + local data)
// =============================================
model Project {
  id              String   @id @default(uuid())
  pipefyCardId    String?  @unique @map("pipefy_card_id")

  // Basic info (from Pipefy)
  title           String
  cliente         String?
  endereco        String?
  pipefyPhase     String?  @map("pipefy_phase") // Current phase from Pipefy

  // Measurements (from Pipefy)
  m2Total         Decimal  @default(0) @map("m2_total") @db.Decimal(10, 2)
  m2Piso          Decimal  @default(0) @map("m2_piso") @db.Decimal(10, 2)
  m2Parede        Decimal  @default(0) @map("m2_parede") @db.Decimal(10, 2)
  m2Teto          Decimal  @default(0) @map("m2_teto") @db.Decimal(10, 2)
  mRodape         Decimal  @default(0) @map("m_rodape") @db.Decimal(10, 2)

  // Additional Pipefy fields
  equipe          String?
  cor             String?
  andamento       String?
  consultor       String?
  material        String?
  detalhamento    String?
  especiais       String?
  linkEscopo      String?  @map("link_escopo")

  // Responsible contact phones (for entry requests, etc.)
  responsiblePhones String[] @default([]) @map("responsible_phones")

  // Admin-managed fields
  status          ProjectStatus @default(EM_EXECUCAO)
  teamStatus      TeamStatus    @default(AGUARDANDO_EQUIPE) @map("team_status")
  estimatedHours  Decimal?      @map("estimated_hours") @db.Decimal(10, 2)
  workedHours     Decimal       @default(0) @map("worked_hours") @db.Decimal(10, 2)
  workflowDescription String?   @map("workflow_description")

  // AI fields (future)
  aiDetailedTasks String?  @map("ai_detailed_tasks")
  aiTasksPrompt   String?  @map("ai_tasks_prompt")

  // Geolocation for check-in
  latitude        Decimal? @db.Decimal(10, 8)
  longitude       Decimal? @db.Decimal(11, 8)
  geofenceRadius  Int      @default(200) @map("geofence_radius") // meters

  // Night Shift configuration
  isNightShift      Boolean   @default(false) @map("is_night_shift")
  nightShiftSlots   Int?      @map("night_shift_slots")  // number of slots/vacancies
  nightShiftStart   DateTime? @map("night_shift_start")  // period start date
  nightShiftEnd     DateTime? @map("night_shift_end")    // period end date

  // Work Schedule (horários de trabalho permitidos)
  workStartTime     String?   @map("work_start_time")  // Ex: "08:00"
  workEndTime       String?   @map("work_end_time")    // Ex: "17:00"
  allowSaturday     Boolean   @default(false) @map("allow_saturday")
  allowSunday       Boolean   @default(false) @map("allow_sunday")
  allowNightWork    Boolean   @default(false) @map("allow_night_work")

  // Deadline and scheduling
  deadlineDate      DateTime? @map("deadline_date")    // Data prazo do projeto
  estimatedDays     Int?      @map("estimated_days")   // Dias estimados de trabalho
  teamSize          Int?      @map("team_size")        // Quantidade de pessoas na equipe

  // Timestamps
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  pipefySyncedAt  DateTime? @map("pipefy_synced_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  assignments           ProjectAssignment[]
  checkins              Checkin[]
  reports               Report[]
  documents             ProjectDocument[]
  generatedReports      GeneratedReport[]
  telegramConfig        TelegramConfig?
  activeLocations       UserLocation[]
  nightShiftInvites     NightShiftInvite[]
  contributionRequests  ContributionRequest[]
  helpRequests          HelpRequest[]
  feedPosts             FeedPost[]
  tasks                 ProjectTask[]

  @@map("projects")
}

enum ProjectStatus {
  EM_EXECUCAO
  PAUSADO
  CONCLUIDO
  CANCELADO
}

enum TeamStatus {
  AGUARDANDO_EQUIPE    // Aguardando definição de equipe
  EQUIPE_DEFINIDA      // Equipe já definida
  EQUIPE_INCOMPLETA    // Equipe parcialmente definida
}

// =============================================
// PROJECT ASSIGNMENTS (Many-to-Many: Users <-> Projects)
// =============================================
model ProjectAssignment {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId     String    @map("project_id")
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  assignedById  String?   @map("assigned_by")
  assignedBy    AdminUser? @relation("AssignedByAdmin", fields: [assignedById], references: [id])
  assignedAt    DateTime  @default(now()) @map("assigned_at")
  removedAt     DateTime? @map("removed_at")
  isActive      Boolean   @default(true) @map("is_active")

  // Role within this project
  projectRole   ProjectRole @default(APLICADOR) @map("project_role")

  @@unique([userId, projectId])
  @@map("project_assignments")
}

enum ProjectRole {
  // Equipe de Aplicação
  LIDER              // Líder da equipe
  APLICADOR          // Aplicador principal
  APLICADOR_AUX      // Aplicador auxiliar

  // Equipe de Preparação
  LIDER_PREPARACAO   // Líder de preparação
  PREPARADOR         // Preparador
  AUXILIAR           // Auxiliar
}

// =============================================
// NIGHT SHIFT INVITES
// =============================================
model NightShiftInvite {
  id          String       @id @default(uuid())
  projectId   String       @map("project_id")
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId      String       @map("user_id")
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  status      InviteStatus @default(PENDING)
  invitedAt   DateTime     @default(now()) @map("invited_at")
  respondedAt DateTime?    @map("responded_at")
  invitedById String?      @map("invited_by")
  invitedBy   AdminUser?   @relation(fields: [invitedById], references: [id])

  @@unique([projectId, userId])
  @@map("night_shift_invites")
}

enum InviteStatus {
  PENDING    // Awaiting response
  ACCEPTED   // Accepted
  DECLINED   // Declined
  EXPIRED    // Expired without response
}

// =============================================
// CHECK-INS / CHECK-OUTS
// =============================================
model Checkin {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId       String    @map("project_id")
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  checkinAt       DateTime  @default(now()) @map("checkin_at")
  checkoutAt      DateTime? @map("checkout_at")

  // Location data
  checkinLatitude   Decimal?  @map("checkin_latitude") @db.Decimal(10, 8)
  checkinLongitude  Decimal?  @map("checkin_longitude") @db.Decimal(11, 8)
  checkoutLatitude  Decimal?  @map("checkout_latitude") @db.Decimal(10, 8)
  checkoutLongitude Decimal?  @map("checkout_longitude") @db.Decimal(11, 8)

  // Checkout reason
  checkoutReason  CheckoutReason? @map("checkout_reason")

  // Calculated hours
  hoursWorked     Decimal?  @map("hours_worked") @db.Decimal(10, 2)

  // Validation
  isValid         Boolean   @default(true) @map("is_valid")
  isIrregular     Boolean   @default(false) @map("is_irregular") // No location after 3 attempts
  validationNotes String?   @map("validation_notes")

  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  reports         Report[]

  @@index([userId, checkinAt])
  @@index([projectId, checkinAt])
  @@map("checkins")
}

enum CheckoutReason {
  FIM_EXPEDIENTE
  OUTRO_PROJETO
  COMPRA_INSUMOS
  ALMOCO_INTERVALO
}

// =============================================
// REPORTS (Audio + Photos from team)
// =============================================
model Report {
  id            String       @id @default(uuid())
  userId        String       @map("user_id")
  user          User         @relation(fields: [userId], references: [id])
  projectId     String       @map("project_id")
  project       Project      @relation(fields: [projectId], references: [id])
  checkinId     String?      @map("checkin_id")
  checkin       Checkin?     @relation(fields: [checkinId], references: [id])

  // Report type
  reportType    ReportType   @default(DAILY) @map("report_type")
  reportDate    DateTime     @default(now()) @map("report_date") @db.Date

  // Audio
  audioFileUrl        String?   @map("audio_file_url")
  audioDurationSeconds Int?     @map("audio_duration_seconds")

  // AI-processed content
  audioTranscription  String?   @map("audio_transcription")
  aiSummary           String?   @map("ai_summary")
  aiProcessedAt       DateTime? @map("ai_processed_at")

  // Quick tags selected
  tags          String[]

  // Notes
  notes         String?

  // Status
  status        ReportStatus @default(DRAFT)
  submittedAt   DateTime?    @map("submitted_at")

  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  photos        ReportPhoto[]

  @@index([projectId, reportDate])
  @@map("reports")
}

enum ReportType {
  DAILY
  PERIOD
  INCIDENT
}

enum ReportStatus {
  DRAFT
  SUBMITTED
  PROCESSED
}

// =============================================
// REPORT PHOTOS
// =============================================
model ReportPhoto {
  id          String   @id @default(uuid())
  reportId    String   @map("report_id")
  report      Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)

  fileUrl     String   @map("file_url")
  fileName    String?  @map("file_name")
  fileSize    Int?     @map("file_size")
  mimeType    String?  @map("mime_type")

  caption     String?
  takenAt     DateTime? @map("taken_at")

  sortOrder   Int      @default(0) @map("sort_order")

  createdAt   DateTime @default(now()) @map("created_at")

  @@map("report_photos")
}

// =============================================
// PROJECT DOCUMENTS (Uploaded by admin)
// =============================================
model ProjectDocument {
  id            String     @id @default(uuid())
  projectId     String     @map("project_id")
  project       Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedById  String?    @map("uploaded_by")
  uploadedBy    AdminUser? @relation(fields: [uploadedById], references: [id])

  fileUrl       String     @map("file_url")
  fileName      String     @map("file_name")
  fileSize      Int?       @map("file_size")
  mimeType      String?    @map("mime_type")

  documentType  DocumentType? @map("document_type")
  description   String?

  createdAt     DateTime   @default(now()) @map("created_at")

  @@map("project_documents")
}

enum DocumentType {
  ESCOPO
  PLANTA
  CONTRATO
  OUTROS
}

// =============================================
// GENERATED REPORTS (Admin-generated)
// =============================================
model GeneratedReport {
  id                  String     @id @default(uuid())
  projectId           String?    @map("project_id")
  project             Project?   @relation(fields: [projectId], references: [id])
  generatedByAdminId  String?    @map("generated_by_admin_id")
  generatedByAdmin    AdminUser? @relation(fields: [generatedByAdminId], references: [id])

  type          GeneratedReportType @default(DAILY)

  // Period for period reports
  periodStart   DateTime?  @map("period_start")
  periodEnd     DateTime?  @map("period_end")

  // Content
  title         String?
  content       Json
  aiSummary     String?    @map("ai_summary")

  // Source reports used to generate this
  sourceReportIds String[] @map("source_report_ids")

  // File export
  pdfUrl        String?    @map("pdf_url")

  createdAt     DateTime   @default(now()) @map("created_at")

  @@map("generated_reports")
}

enum GeneratedReportType {
  DAILY
  PERIOD
  CUSTOM
}

// =============================================
// TELEGRAM INTEGRATION (Future - prepared)
// =============================================
model TelegramConfig {
  id            String   @id @default(uuid())
  projectId     String   @unique @map("project_id")
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  chatId        String?  @map("chat_id")
  botToken      String?  @map("bot_token")
  isActive      Boolean  @default(false) @map("is_active")

  // Notification settings
  notifyCheckins      Boolean @default(true) @map("notify_checkins")
  notifyReports       Boolean @default(true) @map("notify_reports")
  notifyDailySummary  Boolean @default(true) @map("notify_daily_summary")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("telegram_config")
}

// =============================================
// USER LOCATION (Real-time tracking)
// =============================================
model UserLocation {
  id            String    @id @default(uuid())
  userId        String    @unique @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  latitude      Decimal   @db.Decimal(10, 8)
  longitude     Decimal   @db.Decimal(11, 8)
  accuracy      Decimal?  @db.Decimal(10, 2) // meters
  heading       Decimal?  @db.Decimal(5, 2)  // degrees
  speed         Decimal?  @db.Decimal(6, 2)  // m/s

  // Status
  isOnline      Boolean   @default(true) @map("is_online")
  batteryLevel  Int?      @map("battery_level") // percentage
  isCharging    Boolean?  @map("is_charging")

  // Geofencing
  isOutOfArea         Boolean  @default(false) @map("is_out_of_area")
  distanceFromProject Int?     @map("distance_from_project") // meters

  // Current project (if checked in)
  currentProjectId String? @map("current_project_id")
  currentProject   Project? @relation(fields: [currentProjectId], references: [id])

  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("user_locations")
}

// =============================================
// LOCATION HISTORY (Optional - for tracking routes)
// =============================================
model LocationHistory {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  latitude      Decimal   @db.Decimal(10, 8)
  longitude     Decimal   @db.Decimal(11, 8)
  accuracy      Decimal?  @db.Decimal(10, 2)

  projectId     String?   @map("project_id")

  recordedAt    DateTime  @default(now()) @map("recorded_at")

  @@index([userId, recordedAt])
  @@map("location_history")
}

// =============================================
// AUDIT LOG
// =============================================
model AuditLog {
  id            String     @id @default(uuid())

  // Who
  adminUserId   String?    @map("admin_user_id")
  adminUser     AdminUser? @relation(fields: [adminUserId], references: [id])
  userId        String?    @map("user_id")
  user          User?      @relation(fields: [userId], references: [id])

  // What
  action        String
  entityType    String?    @map("entity_type")
  entityId      String?    @map("entity_id")

  // Details
  oldValues     Json?      @map("old_values")
  newValues     Json?      @map("new_values")
  description   String?

  // When/Where
  ipAddress     String?    @map("ip_address")
  userAgent     String?    @map("user_agent")
  createdAt     DateTime   @default(now()) @map("created_at")

  @@map("audit_logs")
}

// =============================================
// CONTRIBUTION REQUESTS (Solicitacao para contribuir em projeto)
// =============================================
model ContributionRequest {
  id            String             @id @default(uuid())
  userId        String             @map("user_id")
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId     String             @map("project_id")
  project       Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)

  description   String?            // Motivo/mensagem do aplicador
  status        ContributionStatus @default(PENDING)

  createdAt     DateTime           @default(now()) @map("created_at")
  reviewedAt    DateTime?          @map("reviewed_at")
  reviewedById  String?            @map("reviewed_by")
  reviewedBy    AdminUser?         @relation(fields: [reviewedById], references: [id])

  @@unique([userId, projectId])
  @@map("contribution_requests")
}

enum ContributionStatus {
  PENDING
  APPROVED
  REJECTED
}

// =============================================
// HELP REQUESTS (Solicitacao de Material ou Ajuda)
// =============================================
model HelpRequest {
  id               String           @id @default(uuid())
  userId           String           @map("user_id")
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId        String?          @map("project_id")
  project          Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)

  type             HelpRequestType
  status           HelpRequestStatus @default(PENDING)

  // Material request fields
  materialName     String?          @map("material_name")
  quantity         String?

  // Help request fields
  description      String?

  // Audio recording
  audioUrl         String?          @map("audio_url")
  audioTranscription String?        @map("audio_transcription")

  // Video (only for help requests)
  videoUrl         String?          @map("video_url")

  // Admin response
  adminNotes       String?          @map("admin_notes")
  resolvedAt       DateTime?        @map("resolved_at")
  resolvedById     String?          @map("resolved_by")
  resolvedBy       AdminUser?       @relation(fields: [resolvedById], references: [id])

  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  @@index([userId, createdAt])
  @@index([projectId, createdAt])
  @@map("help_requests")
}

enum HelpRequestType {
  MATERIAL
  HELP
}

enum HelpRequestStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  CANCELLED
}

// Push Notification Subscriptions
model PushSubscription {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Web Push subscription data
  endpoint       String   @unique
  p256dh         String   // Public key for encryption
  auth           String   // Auth secret

  // Device info
  userAgent      String?  @map("user_agent")
  deviceType     String?  @map("device_type")

  // Status
  isActive       Boolean  @default(true) @map("is_active")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("push_subscriptions")
}

// =============================================
// CAMPAIGNS (Campanhas de incentivo)
// =============================================
model Campaign {
  id              String         @id @default(uuid())
  name            String
  description     String?

  // Tipo de campanha
  campaignType    CampaignType   @default(CHALLENGE) @map("campaign_type")

  // Banner principal (video/imagem)
  bannerUrl       String         @map("banner_url")
  bannerType      String         @default("video") @map("banner_type") // "video" | "image"

  // Datas
  startDate       DateTime       @map("start_date")
  endDate         DateTime       @map("end_date")

  // Status
  status          CampaignStatus @default(DRAFT)
  launchedAt      DateTime?      @map("launched_at")

  // Bonus
  xpBonus         Int            @default(0) @map("xp_bonus")       // XP fixo ao participar
  xpMultiplier    Float          @default(1.0) @map("xp_multiplier") // Multiplicador durante campanha

  // Badge associado (para campanhas com premio de badge)
  badgeId         String?        @map("badge_id")
  badge           Badge?         @relation(fields: [badgeId], references: [id])

  // Winner banner (para notificar vencedores)
  winnerBannerUrl   String?      @map("winner_banner_url")
  winnerBannerType  String?      @map("winner_banner_type") // "video" | "image"
  winnerMessage     String?      @map("winner_message")

  // Contadores
  participantCount Int           @default(0) @map("participant_count")

  // Timestamps
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  slides          CampaignSlide[]
  participants    CampaignParticipant[]
  winners         CampaignWinner[]

  @@index([status])
  @@index([startDate, endDate])
  @@map("campaigns")
}

// Tipo de campanha
enum CampaignType {
  CHALLENGE      // Desafio com vencedores selecionados manualmente
  MULTIPLIER     // Multiplicador de XP (pontualidade, assiduidade)
  BONUS          // Bonus fixo de XP ao participar
}

model CampaignSlide {
  id          String   @id @default(uuid())
  campaignId  String   @map("campaign_id")

  order       Int      @default(0)

  // Conteudo
  type        String   @default("text") // "text" | "image" | "video"
  title       String?
  content     String?  @db.Text  // Texto explicativo
  mediaUrl    String?  @map("media_url") // URL da imagem/video

  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@unique([campaignId, order])
  @@map("campaign_slides")
}

model CampaignParticipant {
  id          String   @id @default(uuid())
  campaignId  String   @map("campaign_id")
  userId      String   @map("user_id")
  joinedAt    DateTime @default(now()) @map("joined_at")

  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campaignId, userId])
  @@index([campaignId])
  @@index([userId])
  @@map("campaign_participants")
}

// Vencedores de campanhas
model CampaignWinner {
  id          String   @id @default(uuid())
  campaignId  String   @map("campaign_id")
  userId      String   @map("user_id")

  // Posicao (1o, 2o, 3o lugar, etc)
  position    Int      @default(1)

  // XP premio concedido
  xpAwarded   Int      @default(0) @map("xp_awarded")

  // Badge concedido
  badgeId     String?  @map("badge_id")
  badge       Badge?   @relation(fields: [badgeId], references: [id])

  // Notificacao enviada
  notifiedAt  DateTime? @map("notified_at")

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")

  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campaignId, userId])
  @@index([campaignId])
  @@index([userId])
  @@map("campaign_winners")
}

// =============================================
// BADGES (Selos/Conquistas)
// =============================================
model Badge {
  id          String   @id @default(uuid())
  name        String
  description String?

  // Icone do badge
  iconUrl     String   @map("icon_url")

  // Cor do badge (para destaque)
  color       String   @default("#c9a962")

  // Categoria
  category    BadgeCategory @default(CAMPAIGN)

  // Raridade (afeta visibilidade)
  rarity      BadgeRarity @default(COMMON)

  // Ativo
  isActive    Boolean  @default(true) @map("is_active")

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  userBadges  UserBadge[]
  campaigns   Campaign[]
  winners     CampaignWinner[]

  @@map("badges")
}

enum BadgeCategory {
  CAMPAIGN    // Conquistado em campanha
  ACHIEVEMENT // Conquista por metricas (ex: 100 projetos)
  SPECIAL     // Especial/Evento
  ROLE        // Relacionado a cargo
}

enum BadgeRarity {
  COMMON      // Comum
  RARE        // Raro
  EPIC        // Epico
  LEGENDARY   // Lendario
}

// Badges do usuario (como o selo verificado)
model UserBadge {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  badgeId     String   @map("badge_id")

  // Data de conquista
  awardedAt   DateTime @default(now()) @map("awarded_at")

  // Badge principal (mostrado ao lado do nome como verificado)
  isPrimary   Boolean  @default(false) @map("is_primary")

  // Origem do badge
  campaignId  String?  @map("campaign_id") // Se veio de campanha

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge       Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

enum CampaignStatus {
  DRAFT       // Rascunho, nao visivel
  SCHEDULED   // Agendada para data futura
  ACTIVE      // Ativa e visivel
  ENDED       // Encerrada (data passou)
  CANCELLED   // Cancelada manualmente
}

// =============================================
// FEED POSTS (Posts do feed social)
// =============================================
model FeedPost {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Conteudo do post
  text        String?  @db.Text
  imageUrl    String?  @map("image_url") @db.Text // URL ou base64 da imagem

  // Projeto associado (opcional)
  projectId   String?  @map("project_id")
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  // Contadores (denormalizados para performance)
  likesCount    Int    @default(0) @map("likes_count")
  commentsCount Int    @default(0) @map("comments_count")

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  likes       FeedPostLike[]
  comments    FeedPostComment[]

  @@index([userId, createdAt])
  @@index([projectId])
  @@map("feed_posts")
}

// =============================================
// FEED POST LIKES
// =============================================
model FeedPostLike {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  post      FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("feed_post_likes")
}

// =============================================
// FEED POST COMMENTS
// =============================================
model FeedPostComment {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  post      FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  text      String   @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([postId, createdAt])
  @@index([userId])
  @@map("feed_post_comments")
}

// =============================================
// NOTIFICATIONS (Notificacoes com video e XP)
// =============================================
model Notification {
  id          String   @id @default(uuid())

  // Conteudo
  title       String
  message     String   @db.Text

  // Video opcional
  videoUrl    String?  @map("video_url") @db.Text
  videoDuration Int?   @map("video_duration") // duracao em segundos

  // XP por assistir video completo
  xpReward    Int      @default(0) @map("xp_reward")

  // Status
  isActive    Boolean  @default(true) @map("is_active")

  // Quem criou
  createdById String   @map("created_by")
  createdBy   AdminUser @relation(fields: [createdById], references: [id])

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Stats (denormalizados)
  viewsCount      Int  @default(0) @map("views_count")
  completedCount  Int  @default(0) @map("completed_count")

  // Relations
  views       NotificationView[]

  @@index([isActive, createdAt])
  @@map("notifications")
}

// =============================================
// NOTIFICATION VIEWS (Visualizacoes de notificacao)
// =============================================
model NotificationView {
  id              String   @id @default(uuid())

  notificationId  String   @map("notification_id")
  notification    Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Status de visualizacao
  viewedAt        DateTime @default(now()) @map("viewed_at")

  // Video assistido
  videoStarted    Boolean  @default(false) @map("video_started")
  videoProgress   Int      @default(0) @map("video_progress") // porcentagem 0-100
  videoCompleted  Boolean  @default(false) @map("video_completed")
  videoCompletedAt DateTime? @map("video_completed_at")

  // XP ganho
  xpEarned        Int      @default(0) @map("xp_earned")

  @@unique([notificationId, userId])
  @@index([userId, viewedAt])
  @@index([notificationId])
  @@map("notification_views")
}

// =============================================
// PROJECT TASKS (Tarefas/Etapas do projeto - Gantt)
// =============================================
model ProjectTask {
  id              String        @id @default(uuid())
  projectId       String        @map("project_id")
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Task info
  title           String
  description     String?       @db.Text
  taskType        TaskType      @default(CUSTOM) @map("task_type")

  // Scheduling
  startDate       DateTime?     @map("start_date")
  endDate         DateTime?     @map("end_date")
  durationHours   Decimal       @default(0) @map("duration_hours") @db.Decimal(10, 2)  // Horas trabalhadas nesta etapa
  estimatedHours  Decimal?      @map("estimated_hours") @db.Decimal(10, 2)  // Horas estimadas

  // Input simplificado (dias + pessoas)
  inputDays       Int?          @map("input_days")        // Ex: 1, 2, 3 dias
  inputPeople     Int?          @map("input_people")      // Ex: 4 pessoas
  groupWithNext   Boolean       @default(false) @map("group_with_next")  // Agrupar no mesmo dia que a próxima
  consumesResources Boolean     @default(true) @map("consumes_resources") // False para cura, secagem, etc.

  // Progress
  status          TaskStatus    @default(PENDING)
  progress        Int           @default(0)  // 0-100%

  // Dependencies (tarefa que deve ser concluída antes)
  dependsOnId     String?       @map("depends_on_id")
  dependsOn       ProjectTask?  @relation("TaskDependency", fields: [dependsOnId], references: [id], onDelete: SetNull)
  dependentTasks  ProjectTask[] @relation("TaskDependency")

  // Display order
  sortOrder       Int           @default(0) @map("sort_order")

  // Color for Gantt
  color           String?       // Ex: "#c9a962", "#22c55e"

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@index([projectId, sortOrder])
  @@index([projectId, status])
  @@map("project_tasks")
}

// Tipos de tarefa padrão do sistema STELION
enum TaskType {
  // Preparação
  PREPARACAO
  LIMPEZA_INICIAL
  NIVELAMENTO

  // Aplicação
  APLICACAO_PISO
  APLICACAO_PAREDE
  APLICACAO_TETO
  RODAPE

  // Acabamento
  LIXAMENTO
  SELADOR
  CURA
  ACABAMENTO_FINAL

  // Outros
  INSPECAO
  RETRABALHO
  CUSTOM         // Tarefa personalizada
}

// Status da tarefa
enum TaskStatus {
  PENDING        // Não iniciada
  IN_PROGRESS    // Em andamento
  COMPLETED      // Concluída
  BLOCKED        // Bloqueada (dependência não concluída)
  CANCELLED      // Cancelada
}

// =============================================
// VIDEO JOBS (Processamento assíncrono de vídeos)
// =============================================
model VideoJob {
  id          String         @id @default(uuid())
  status      VideoJobStatus @default(PENDING)
  progress    Int            @default(0)  // 0-100

  // Arquivos de entrada
  inputFiles  Json           @map("input_files")  // Array de nomes dos arquivos

  // Arquivo de saída
  outputUrl   String?        @map("output_url")   // URL/path do arquivo gerado
  outputType  String?        @map("output_type")  // "docx" | "pdf"

  // Metadados do relatório
  metadata    Json?          // projectName, technicianName, clientName, address, visitDate

  // Erro (se falhou)
  error       String?        @db.Text

  // Fase atual do processamento
  currentPhase String?       @map("current_phase")  // "upload", "extracting", "transcribing", "analyzing", "generating"

  // Timestamps
  startedAt   DateTime?      @map("started_at")
  completedAt DateTime?      @map("completed_at")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("video_jobs")
}

enum VideoJobStatus {
  PENDING     // Aguardando processamento
  PROCESSING  // Em processamento
  COMPLETED   // Concluído com sucesso
  FAILED      // Falhou
}

// =============================================
// XP TRANSACTIONS (Histórico de XP)
// =============================================
model XpTransaction {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  // XP info
  amount      Int                    // Quantidade de XP (positivo = ganho, negativo = perdido)
  type        XpTransactionType      // Tipo de transação
  reason      String                 // Descrição legível (ex: "Check-in na obra Casa Silva")

  // Referências opcionais
  checkinId   String?     @map("checkin_id")
  projectId   String?     @map("project_id")
  campaignId  String?     @map("campaign_id")

  // Timestamps
  createdAt   DateTime    @default(now()) @map("created_at")

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("xp_transactions")
}

enum XpTransactionType {
  CHECKIN           // Check-in na obra
  CHECKOUT          // Check-out (bonus por horas trabalhadas)
  REPORT            // Envio de relatório
  CAMPAIGN          // Participação em campanha
  ACHIEVEMENT       // Conquista desbloqueada
  BONUS             // Bonus manual do admin
  VIDEO_WATCHED     // Vídeo assistido
  PENALTY           // Penalidade (XP negativo)
}
