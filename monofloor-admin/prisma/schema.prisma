generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminUser {
  id                    String                @id @default(uuid())
  email                 String                @unique
  passwordHash          String                @map("password_hash")
  name                  String
  role                  AdminRole             @default(ADMIN)
  isActive              Boolean               @default(true) @map("is_active")
  lastLoginAt           DateTime?             @map("last_login_at")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")
  auditLogs             AuditLog[]
  reviewedContributions ContributionRequest[]
  generatedReports      GeneratedReport[]
  resolvedHelpRequests  HelpRequest[]
  nightShiftInvites     NightShiftInvite[]
  notifications         Notification[]
  projectAssignments    ProjectAssignment[]   @relation("AssignedByAdmin")
  uploadedDocuments     ProjectDocument[]
  approvedUsers         User[]                @relation("ApprovedByAdmin")
  promotedUsers         User[]                @relation("PromotedByAdmin")

  @@map("admin_users")
}

model User {
  id                             String                      @id @default(uuid())
  email                          String                      @unique
  passwordHash                   String                      @map("password_hash")
  name                           String
  username                       String                      @unique
  phone                          String?
  photoUrl                       String?                     @map("photo_url")
  status                         UserStatus                  @default(PENDING_APPROVAL)
  approvedAt                     DateTime?                   @map("approved_at")
  approvedById                   String?                     @map("approved_by")
  rejectionReason                String?                     @map("rejection_reason")
  role                           UserRole                    @default(AUXILIAR)
  promotedAt                     DateTime?                   @map("promoted_at")
  promotedById                   String?                     @map("promoted_by")
  xpTotal                        Int                         @default(0) @map("xp_total")
  level                          Int                         @default(1)
  totalHoursWorked               Decimal                     @default(0) @map("total_hours_worked") @db.Decimal(10, 2)
  totalM2Applied                 Decimal                     @default(0) @map("total_m2_applied") @db.Decimal(10, 2)
  totalProjectsCount             Int                         @default(0) @map("total_projects_count")
  createdAt                      DateTime                    @default(now()) @map("created_at")
  updatedAt                      DateTime                    @updatedAt @map("updated_at")
  cpf                            String?                     @unique
  documentUrl                    String?                     @map("document_url")
  lastPunctualDate               DateTime?                   @map("last_punctual_date")
  punctualityMultiplier          Decimal                     @default(1.1) @map("punctuality_multiplier") @db.Decimal(3, 1)
  punctualityStreak              Int                         @default(0) @map("punctuality_streak")
  absenceNotices                 AbsenceNotice[]
  absenceRecords                 AbsenceRecord[]
  auditLogs                      AuditLog[]
  campaignParticipations         CampaignParticipant[]
  campaignWins                   CampaignWinner[]
  checkins                       Checkin[]
  contributionRequests           ContributionRequest[]
  originalReportResponsibilities DailyReportResponsibility[] @relation("OriginalReportResponsible")
  currentReportResponsibilities  DailyReportResponsibility[] @relation("CurrentReportResponsible")
  feedPostComments               FeedPostComment[]
  feedPostLikes                  FeedPostLike[]
  feedPosts                      FeedPost[]
  helpRequests                   HelpRequest[]
  locationHistory                LocationHistory[]
  nightShiftInvites              NightShiftInvite[]
  notificationViews              NotificationView[]
  pendingNotifications           PendingNotification[]
  projectAssignments             ProjectAssignment[]
  pushSubscriptions              PushSubscription[]
  quizAttempts                   QuizAttempt[]
  reportReminders                ReportReminder[]
  reports                        Report[]
  saturdaySchedules              SaturdaySchedule[]
  taskAssignments                TaskAssignment[]
  taskCompletions                TaskCompletion[]
  unreportedAbsences             UnreportedAbsence[]
  badges                         UserBadge[]
  location                       UserLocation?
  approvedBy                     AdminUser?                  @relation("ApprovedByAdmin", fields: [approvedById], references: [id])
  promotedBy                     AdminUser?                  @relation("PromotedByAdmin", fields: [promotedById], references: [id])
  videoProgress                  VideoProgress[]
  workDayResponses               WorkDayResponse[]
  xpTransactions                 XpTransaction[]

  @@map("users")
}

model Project {
  id                          String                      @id @default(uuid())
  pipefyCardId                String?                     @unique @map("pipefy_card_id")
  title                       String
  cliente                     String?
  endereco                    String?
  pipefyPhase                 String?                     @map("pipefy_phase")
  m2Total                     Decimal                     @default(0) @map("m2_total") @db.Decimal(10, 2)
  m2Piso                      Decimal                     @default(0) @map("m2_piso") @db.Decimal(10, 2)
  m2Parede                    Decimal                     @default(0) @map("m2_parede") @db.Decimal(10, 2)
  m2Teto                      Decimal                     @default(0) @map("m2_teto") @db.Decimal(10, 2)
  mRodape                     Decimal                     @default(0) @map("m_rodape") @db.Decimal(10, 2)
  equipe                      String?
  cor                         String?
  andamento                   String?
  consultor                   String?
  material                    String?
  detalhamento                String?
  especiais                   String?
  linkEscopo                  String?                     @map("link_escopo")
  status                      ProjectStatus               @default(EM_EXECUCAO)
  estimatedHours              Decimal?                    @map("estimated_hours") @db.Decimal(10, 2)
  workedHours                 Decimal                     @default(0) @map("worked_hours") @db.Decimal(10, 2)
  workflowDescription         String?                     @map("workflow_description")
  aiDetailedTasks             String?                     @map("ai_detailed_tasks")
  aiTasksPrompt               String?                     @map("ai_tasks_prompt")
  latitude                    Decimal?                    @db.Decimal(10, 8)
  longitude                   Decimal?                    @db.Decimal(11, 8)
  geofenceRadius              Int                         @default(200) @map("geofence_radius")
  isNightShift                Boolean                     @default(false) @map("is_night_shift")
  nightShiftSlots             Int?                        @map("night_shift_slots")
  nightShiftStart             DateTime?                   @map("night_shift_start")
  nightShiftEnd               DateTime?                   @map("night_shift_end")
  startedAt                   DateTime?                   @map("started_at")
  completedAt                 DateTime?                   @map("completed_at")
  pipefySyncedAt              DateTime?                   @map("pipefy_synced_at")
  createdAt                   DateTime                    @default(now()) @map("created_at")
  updatedAt                   DateTime                    @updatedAt @map("updated_at")
  teamStatus                  TeamStatus                  @default(AGUARDANDO_EQUIPE) @map("team_status")
  responsiblePhones           String[]                    @default([]) @map("responsible_phones")
  allowNightWork              Boolean                     @default(false) @map("allow_night_work")
  allowSaturday               Boolean                     @default(false) @map("allow_saturday")
  allowSunday                 Boolean                     @default(false) @map("allow_sunday")
  deadlineDate                DateTime?                   @map("deadline_date")
  estimatedDays               Int?                        @map("estimated_days")
  workEndTime                 String?                     @map("work_end_time")
  workStartTime               String?                     @map("work_start_time")
  teamSize                    Int?                        @map("team_size")
  isTravelMode                Boolean                     @default(false) @map("is_travel_mode")
  currentModule               ProjectModule?              @map("current_module")
  checkins                    Checkin[]
  comercialData               ComercialData?
  contrato                    Contrato?
  contributionRequests        ContributionRequest[]
  dailyReportResponsibilities DailyReportResponsibility[]
  execucao                    Execucao?
  feedPosts                   FeedPost[]
  generatedReports            GeneratedReport[]
  helpRequests                HelpRequest[]
  nightShiftInvites           NightShiftInvite[]
  planejamento                Planejamento?
  posVendas                   PosVenda[]
  assignments                 ProjectAssignment[]
  documents                   ProjectDocument[]
  tasks                       ProjectTask[]
  videos                      ProjectVideo[]
  reportReminders             ReportReminder[]
  reports                     Report[]
  saturdaySchedules           SaturdaySchedule[]
  telegramConfig              TelegramConfig?
  timelineEvents              TimelineEvent[]
  activeLocations             UserLocation[]
  xpTransactions              XpTransaction[]

  @@map("projects")
}

model ProjectAssignment {
  id           String      @id @default(uuid())
  userId       String      @map("user_id")
  projectId    String      @map("project_id")
  assignedById String?     @map("assigned_by")
  assignedAt   DateTime    @default(now()) @map("assigned_at")
  removedAt    DateTime?   @map("removed_at")
  isActive     Boolean     @default(true) @map("is_active")
  projectRole  ProjectRole @default(APLICADOR_I) @map("project_role")
  assignedBy   AdminUser?  @relation("AssignedByAdmin", fields: [assignedById], references: [id])
  project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@map("project_assignments")
}

model NightShiftInvite {
  id          String       @id @default(uuid())
  projectId   String       @map("project_id")
  userId      String       @map("user_id")
  status      InviteStatus @default(PENDING)
  invitedAt   DateTime     @default(now()) @map("invited_at")
  respondedAt DateTime?    @map("responded_at")
  invitedById String?      @map("invited_by")
  invitedBy   AdminUser?   @relation(fields: [invitedById], references: [id])
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("night_shift_invites")
}

model Checkin {
  id                        String           @id @default(uuid())
  userId                    String           @map("user_id")
  projectId                 String           @map("project_id")
  checkinAt                 DateTime         @default(now()) @map("checkin_at")
  checkoutAt                DateTime?        @map("checkout_at")
  checkinLatitude           Decimal?         @map("checkin_latitude") @db.Decimal(10, 8)
  checkinLongitude          Decimal?         @map("checkin_longitude") @db.Decimal(11, 8)
  checkoutLatitude          Decimal?         @map("checkout_latitude") @db.Decimal(10, 8)
  checkoutLongitude         Decimal?         @map("checkout_longitude") @db.Decimal(11, 8)
  checkoutReason            CheckoutReason?  @map("checkout_reason")
  hoursWorked               Decimal?         @map("hours_worked") @db.Decimal(10, 2)
  isValid                   Boolean          @default(true) @map("is_valid")
  validationNotes           String?          @map("validation_notes")
  createdAt                 DateTime         @default(now()) @map("created_at")
  isIrregular               Boolean          @default(false) @map("is_irregular")
  checkinDistance           Float?           @map("checkin_distance")
  checkoutDistance          Float?           @map("checkout_distance")
  hoursNormal               Decimal?         @map("hours_normal") @db.Decimal(10, 2)
  hoursOvertime             Decimal?         @map("hours_overtime") @db.Decimal(10, 2)
  hoursSupplies             Decimal?         @map("hours_supplies") @db.Decimal(10, 2)
  hoursTravel               Decimal?         @map("hours_travel") @db.Decimal(10, 2)
  isDistantCheckin          Boolean          @default(false) @map("is_distant_checkin")
  isDistantCheckout         Boolean          @default(false) @map("is_distant_checkout")
  lunchBreakMinutes         Int?             @map("lunch_break_minutes")
  lunchDeduction            Int?             @map("lunch_deduction")
  lunchPenaltyApplied       Boolean          @default(false) @map("lunch_penalty_applied")
  autoCheckoutJustification String?          @map("auto_checkout_justification")
  autoCheckoutJustifiedAt   DateTime?        @map("auto_checkout_justified_at")
  isAutoCheckout            Boolean          @default(false) @map("is_auto_checkout")
  expectedTime              String?          @map("expected_time")
  isFirstOfDay              Boolean          @default(false) @map("is_first_of_day")
  isPunctual                Boolean?         @map("is_punctual")
  minutesLate               Int?             @map("minutes_late")
  project                   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user                      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  reportReminders           ReportReminder[]
  reports                   Report[]
  taskCompletions           TaskCompletion[]

  @@index([userId, checkinAt])
  @@index([projectId, checkinAt])
  @@map("checkins")
}

model Report {
  id                   String        @id @default(uuid())
  userId               String        @map("user_id")
  projectId            String        @map("project_id")
  checkinId            String?       @map("checkin_id")
  reportType           ReportType    @default(DAILY) @map("report_type")
  reportDate           DateTime      @default(now()) @map("report_date") @db.Date
  audioFileUrl         String?       @map("audio_file_url")
  audioDurationSeconds Int?          @map("audio_duration_seconds")
  audioTranscription   String?       @map("audio_transcription")
  aiSummary            String?       @map("ai_summary")
  aiProcessedAt        DateTime?     @map("ai_processed_at")
  tags                 String[]
  notes                String?
  status               ReportStatus  @default(DRAFT)
  submittedAt          DateTime?     @map("submitted_at")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")
  photos               ReportPhoto[]
  checkin              Checkin?      @relation(fields: [checkinId], references: [id])
  project              Project       @relation(fields: [projectId], references: [id])
  user                 User          @relation(fields: [userId], references: [id])

  @@index([projectId, reportDate])
  @@map("reports")
}

model ReportPhoto {
  id        String    @id @default(uuid())
  reportId  String    @map("report_id")
  fileUrl   String    @map("file_url")
  fileName  String?   @map("file_name")
  fileSize  Int?      @map("file_size")
  mimeType  String?   @map("mime_type")
  caption   String?
  takenAt   DateTime? @map("taken_at")
  sortOrder Int       @default(0) @map("sort_order")
  createdAt DateTime  @default(now()) @map("created_at")
  report    Report    @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@map("report_photos")
}

model ProjectDocument {
  id           String        @id @default(uuid())
  projectId    String        @map("project_id")
  uploadedById String?       @map("uploaded_by")
  fileUrl      String        @map("file_url")
  fileName     String        @map("file_name")
  fileSize     Int?          @map("file_size")
  mimeType     String?       @map("mime_type")
  documentType DocumentType? @map("document_type")
  description  String?
  createdAt    DateTime      @default(now()) @map("created_at")
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy   AdminUser?    @relation(fields: [uploadedById], references: [id])

  @@map("project_documents")
}

model GeneratedReport {
  id                 String              @id @default(uuid())
  projectId          String?             @map("project_id")
  generatedByAdminId String?             @map("generated_by_admin_id")
  type               GeneratedReportType @default(DAILY)
  periodStart        DateTime?           @map("period_start")
  periodEnd          DateTime?           @map("period_end")
  title              String?
  content            Json
  aiSummary          String?             @map("ai_summary")
  sourceReportIds    String[]            @map("source_report_ids")
  pdfUrl             String?             @map("pdf_url")
  createdAt          DateTime            @default(now()) @map("created_at")
  generatedByAdmin   AdminUser?          @relation(fields: [generatedByAdminId], references: [id])
  project            Project?            @relation(fields: [projectId], references: [id])

  @@map("generated_reports")
}

model TelegramConfig {
  id                 String   @id @default(uuid())
  projectId          String   @unique @map("project_id")
  chatId             String?  @map("chat_id")
  botToken           String?  @map("bot_token")
  isActive           Boolean  @default(false) @map("is_active")
  notifyCheckins     Boolean  @default(true) @map("notify_checkins")
  notifyReports      Boolean  @default(true) @map("notify_reports")
  notifyDailySummary Boolean  @default(true) @map("notify_daily_summary")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  project            Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("telegram_config")
}

model UserLocation {
  id                  String    @id @default(uuid())
  userId              String    @unique @map("user_id")
  latitude            Decimal   @db.Decimal(10, 8)
  longitude           Decimal   @db.Decimal(11, 8)
  accuracy            Decimal?  @db.Decimal(10, 2)
  heading             Decimal?  @db.Decimal(5, 2)
  speed               Decimal?  @db.Decimal(6, 2)
  isOnline            Boolean   @default(true) @map("is_online")
  batteryLevel        Int?      @map("battery_level")
  currentProjectId    String?   @map("current_project_id")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  distanceFromProject Int?      @map("distance_from_project")
  isCharging          Boolean?  @map("is_charging")
  isOutOfArea         Boolean   @default(false) @map("is_out_of_area")
  gpsOffAt            DateTime? @map("gps_off_at")
  gpsStatus           String?   @map("gps_status")
  gpsOffConfirmations Int       @default(0) @map("gps_off_confirmations")
  currentProject      Project?  @relation(fields: [currentProjectId], references: [id])
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_locations")
}

model LocationHistory {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  latitude   Decimal  @db.Decimal(10, 8)
  longitude  Decimal  @db.Decimal(11, 8)
  accuracy   Decimal? @db.Decimal(10, 2)
  projectId  String?  @map("project_id")
  recordedAt DateTime @default(now()) @map("recorded_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, recordedAt])
  @@map("location_history")
}

model AuditLog {
  id          String     @id @default(uuid())
  adminUserId String?    @map("admin_user_id")
  userId      String?    @map("user_id")
  action      String
  entityType  String?    @map("entity_type")
  entityId    String?    @map("entity_id")
  oldValues   Json?      @map("old_values")
  newValues   Json?      @map("new_values")
  description String?
  ipAddress   String?    @map("ip_address")
  userAgent   String?    @map("user_agent")
  createdAt   DateTime   @default(now()) @map("created_at")
  adminUser   AdminUser? @relation(fields: [adminUserId], references: [id])
  user        User?      @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model ContributionRequest {
  id           String             @id @default(uuid())
  userId       String             @map("user_id")
  projectId    String             @map("project_id")
  description  String?
  status       ContributionStatus @default(PENDING)
  createdAt    DateTime           @default(now()) @map("created_at")
  reviewedAt   DateTime?          @map("reviewed_at")
  reviewedById String?            @map("reviewed_by")
  project      Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviewedBy   AdminUser?         @relation(fields: [reviewedById], references: [id])
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@map("contribution_requests")
}

model HelpRequest {
  id                 String            @id @default(uuid())
  userId             String            @map("user_id")
  projectId          String?           @map("project_id")
  type               HelpRequestType
  status             HelpRequestStatus @default(PENDING)
  materialName       String?           @map("material_name")
  quantity           String?
  description        String?
  audioUrl           String?           @map("audio_url")
  audioTranscription String?           @map("audio_transcription")
  videoUrl           String?           @map("video_url")
  adminNotes         String?           @map("admin_notes")
  resolvedAt         DateTime?         @map("resolved_at")
  resolvedById       String?           @map("resolved_by")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  project            Project?          @relation(fields: [projectId], references: [id])
  resolvedBy         AdminUser?        @relation(fields: [resolvedById], references: [id])
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([projectId, createdAt])
  @@map("help_requests")
}

model PushSubscription {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  type        String   @default("web") // "web" or "native"
  platform    String?  // "ios", "android", or null for web
  // Web Push fields (optional for native)
  endpoint    String?  @unique
  p256dh      String?
  auth        String?
  // Native Push fields (APNs/FCM)
  deviceToken String?  @unique @map("device_token")
  // Common fields
  userAgent   String?  @map("user_agent")
  deviceType  String?  @map("device_type")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceToken])
  @@map("push_subscriptions")
}

model Campaign {
  id               String                @id @default(uuid())
  name             String
  description      String?
  bannerUrl        String                @map("banner_url")
  bannerType       String                @default("video") @map("banner_type")
  startDate        DateTime              @map("start_date")
  endDate          DateTime              @map("end_date")
  status           CampaignStatus        @default(DRAFT)
  launchedAt       DateTime?             @map("launched_at")
  xpBonus          Int                   @default(0) @map("xp_bonus")
  xpMultiplier     Float                 @default(1.0) @map("xp_multiplier")
  participantCount Int                   @default(0) @map("participant_count")
  createdAt        DateTime              @default(now()) @map("created_at")
  updatedAt        DateTime              @updatedAt @map("updated_at")
  badgeId          String?               @map("badge_id")
  campaignType     CampaignType          @default(CHALLENGE) @map("campaign_type")
  winnerBannerType String?               @map("winner_banner_type")
  winnerBannerUrl  String?               @map("winner_banner_url")
  winnerMessage    String?               @map("winner_message")
  participants     CampaignParticipant[]
  slides           CampaignSlide[]
  winners          CampaignWinner[]
  badge            Badge?                @relation(fields: [badgeId], references: [id])

  @@index([status])
  @@index([startDate, endDate])
  @@map("campaigns")
}

model CampaignSlide {
  id         String   @id @default(uuid())
  campaignId String   @map("campaign_id")
  order      Int      @default(0)
  type       String   @default("text")
  title      String?
  content    String?
  mediaUrl   String?  @map("media_url")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, order])
  @@index([campaignId])
  @@map("campaign_slides")
}

model CampaignParticipant {
  id         String   @id @default(uuid())
  campaignId String   @map("campaign_id")
  userId     String   @map("user_id")
  joinedAt   DateTime @default(now()) @map("joined_at")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campaignId, userId])
  @@index([campaignId])
  @@index([userId])
  @@map("campaign_participants")
}

model CampaignWinner {
  id         String    @id @default(uuid())
  campaignId String    @map("campaign_id")
  userId     String    @map("user_id")
  position   Int       @default(1)
  xpAwarded  Int       @default(0) @map("xp_awarded")
  badgeId    String?   @map("badge_id")
  notifiedAt DateTime? @map("notified_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  badge      Badge?    @relation(fields: [badgeId], references: [id])
  campaign   Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campaignId, userId])
  @@index([campaignId])
  @@index([userId])
  @@map("campaign_winners")
}

model Badge {
  id          String           @id @default(uuid())
  name        String
  description String?
  iconUrl     String           @map("icon_url")
  color       String           @default("#c9a962")
  category    BadgeCategory    @default(CAMPAIGN)
  rarity      BadgeRarity      @default(COMMON)
  isActive    Boolean          @default(true) @map("is_active")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  winners     CampaignWinner[]
  campaigns   Campaign[]
  userBadges  UserBadge[]

  @@map("badges")
}

model UserBadge {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  badgeId    String   @map("badge_id")
  awardedAt  DateTime @default(now()) @map("awarded_at")
  isPrimary  Boolean  @default(false) @map("is_primary")
  campaignId String?  @map("campaign_id")
  badge      Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

model FeedPost {
  id            String            @id @default(uuid())
  userId        String            @map("user_id")
  text          String?
  imageUrl      String?           @map("image_url")
  projectId     String?           @map("project_id")
  likesCount    Int               @default(0) @map("likes_count")
  commentsCount Int               @default(0) @map("comments_count")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  comments      FeedPostComment[]
  likes         FeedPostLike[]
  project       Project?          @relation(fields: [projectId], references: [id])
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([projectId])
  @@map("feed_posts")
}

model FeedPostLike {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  post      FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("feed_post_likes")
}

model FeedPostComment {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  userId    String   @map("user_id")
  text      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  post      FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
  @@index([userId])
  @@map("feed_post_comments")
}

model Notification {
  id             String             @id @default(uuid())
  title          String
  message        String
  videoUrl       String?            @map("video_url")
  videoDuration  Int?               @map("video_duration")
  xpReward       Int                @default(0) @map("xp_reward")
  isActive       Boolean            @default(true) @map("is_active")
  createdById    String             @map("created_by")
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  viewsCount     Int                @default(0) @map("views_count")
  completedCount Int                @default(0) @map("completed_count")
  views          NotificationView[]
  createdBy      AdminUser          @relation(fields: [createdById], references: [id])

  @@index([isActive, createdAt])
  @@map("notifications")
}

model NotificationView {
  id               String       @id @default(uuid())
  notificationId   String       @map("notification_id")
  userId           String       @map("user_id")
  viewedAt         DateTime     @default(now()) @map("viewed_at")
  videoStarted     Boolean      @default(false) @map("video_started")
  videoProgress    Int          @default(0) @map("video_progress")
  videoCompleted   Boolean      @default(false) @map("video_completed")
  videoCompletedAt DateTime?    @map("video_completed_at")
  xpEarned         Int          @default(0) @map("xp_earned")
  notification     Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([notificationId, userId])
  @@index([userId, viewedAt])
  @@index([notificationId])
  @@map("notification_views")
}

model ProjectTask {
  id                  String              @id @default(uuid())
  projectId           String              @map("project_id")
  title               String
  description         String?
  taskType            TaskType            @default(CUSTOM) @map("task_type")
  startDate           DateTime?           @map("start_date")
  endDate             DateTime?           @map("end_date")
  durationHours       Decimal             @default(0) @map("duration_hours") @db.Decimal(10, 2)
  estimatedHours      Decimal?            @map("estimated_hours") @db.Decimal(10, 2)
  status              TaskStatus          @default(PENDING)
  progress            Int                 @default(0)
  dependsOnId         String?             @map("depends_on_id")
  sortOrder           Int                 @default(0) @map("sort_order")
  color               String?
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  groupWithNext       Boolean             @default(false) @map("group_with_next")
  inputDays           Int?                @map("input_days")
  inputPeople         Int?                @map("input_people")
  consumesResources   Boolean             @default(true) @map("consumes_resources")
  publishedAt         DateTime?           @map("published_at")
  publishedToApp      Boolean             @default(false) @map("published_to_app")
  completionType      TaskCompletionType? @map("completion_type")
  phase               TaskPhase           @default(PREPARO)
  surface             TaskSurface         @default(GERAL)
  curaAutoCompletedAt DateTime?           @map("cura_auto_completed_at")
  curaStartedAt       DateTime?           @map("cura_started_at")
  dependsOn           ProjectTask?        @relation("TaskDependency", fields: [dependsOnId], references: [id])
  dependentTasks      ProjectTask[]       @relation("TaskDependency")
  project             Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedUsers       TaskAssignment[]
  completions         TaskCompletion[]

  @@index([projectId, sortOrder])
  @@index([projectId, status])
  @@index([projectId, publishedToApp])
  @@map("project_tasks")
}

model TaskAssignment {
  id            String      @id @default(uuid())
  projectTaskId String      @map("project_task_id")
  userId        String      @map("user_id")
  assignedAt    DateTime    @default(now()) @map("assigned_at")
  projectTask   ProjectTask @relation(fields: [projectTaskId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectTaskId, userId])
  @@index([projectTaskId])
  @@index([userId])
  @@map("task_assignments")
}

model VideoJob {
  id           String         @id @default(uuid())
  status       VideoJobStatus @default(PENDING)
  progress     Int            @default(0)
  inputFiles   Json           @map("input_files")
  outputUrl    String?        @map("output_url")
  outputType   String?        @map("output_type")
  metadata     Json?
  error        String?
  currentPhase String?        @map("current_phase")
  startedAt    DateTime?      @map("started_at")
  completedAt  DateTime?      @map("completed_at")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("video_jobs")
}

model XpTransaction {
  id         String            @id @default(uuid())
  userId     String            @map("user_id")
  amount     Int
  type       XpTransactionType
  reason     String
  checkinId  String?           @map("checkin_id")
  projectId  String?           @map("project_id")
  campaignId String?           @map("campaign_id")
  createdAt  DateTime          @default(now()) @map("created_at")
  project    Project?          @relation(fields: [projectId], references: [id])
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([projectId])
  @@map("xp_transactions")
}

model TaskCompletion {
  id            String      @id @default(uuid())
  projectTaskId String      @map("project_task_id")
  userId        String      @map("user_id")
  checkinId     String      @map("checkin_id")
  completedAt   DateTime    @default(now()) @map("completed_at")
  checkin       Checkin     @relation(fields: [checkinId], references: [id], onDelete: Cascade)
  projectTask   ProjectTask @relation(fields: [projectTaskId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectTaskId, checkinId])
  @@index([projectTaskId])
  @@index([userId, completedAt])
  @@map("task_completions")
}

model ReportReminder {
  id              String         @id @default(uuid())
  userId          String         @map("user_id")
  projectId       String         @map("project_id")
  checkinId       String         @map("checkin_id")
  scheduledFor    DateTime       @map("scheduled_for")
  reminderCount   Int            @default(0) @map("reminder_count")
  status          ReminderStatus @default(PENDING)
  sentAt          DateTime?      @map("sent_at")
  reportSubmitted Boolean        @default(false) @map("report_submitted")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  checkin         Checkin        @relation(fields: [checkinId], references: [id], onDelete: Cascade)
  project         Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([scheduledFor, status])
  @@map("report_reminders")
}

model AbsenceNotice {
  id               String            @id @default(uuid())
  userId           String            @map("user_id")
  absenceDate      DateTime          @map("absence_date") @db.Date
  reason           String
  noticeType       AbsenceNoticeType @default(ADVANCE) @map("notice_type")
  wasAdvanceNotice Boolean           @default(true) @map("was_advance_notice")
  xpPenalty        Int               @default(0) @map("xp_penalty")
  multiplierReset  Boolean           @default(false) @map("multiplier_reset")
  status           AbsenceStatus     @default(CONFIRMED)
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  acknowledgedAt   DateTime?         @map("acknowledged_at")
  acknowledgedBy   String?           @map("acknowledged_by")
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, absenceDate])
  @@index([userId, absenceDate])
  @@index([absenceDate, status])
  @@map("absence_notices")
}

model UnreportedAbsence {
  id                 String                  @id @default(uuid())
  userId             String                  @map("user_id")
  absenceDate        DateTime                @map("absence_date") @db.Date
  detectedAt         DateTime                @default(now()) @map("detected_at")
  status             UnreportedAbsenceStatus @default(PENDING)
  userResponse       String?                 @map("user_response")
  reason             String?
  explanation        String?
  notificationSentAt DateTime?               @map("notification_sent_at")
  respondedAt        DateTime?               @map("responded_at")
  xpPenalty          Int                     @default(0) @map("xp_penalty")
  multiplierReset    Boolean                 @default(false) @map("multiplier_reset")
  createdAt          DateTime                @default(now()) @map("created_at")
  updatedAt          DateTime                @updatedAt @map("updated_at")
  acknowledgedAt     DateTime?               @map("acknowledged_at")
  acknowledgedBy     String?                 @map("acknowledged_by")
  user               User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, absenceDate])
  @@index([userId, status])
  @@index([absenceDate, status])
  @@map("unreported_absences")
}

model DailyWorkSummary {
  id                  String    @id @default(uuid())
  userId              String    @map("user_id")
  workDate            DateTime  @map("work_date") @db.Date
  hoursNormal         Decimal   @default(0) @map("hours_normal") @db.Decimal(10, 2)
  hoursOvertime       Decimal   @default(0) @map("hours_overtime") @db.Decimal(10, 2)
  hoursTravelMode     Decimal   @default(0) @map("hours_travel_mode") @db.Decimal(10, 2)
  hoursTravel         Decimal   @default(0) @map("hours_travel") @db.Decimal(10, 2)
  hoursSupplies       Decimal   @default(0) @map("hours_supplies") @db.Decimal(10, 2)
  totalHoursWorked    Decimal   @default(0) @map("total_hours_worked") @db.Decimal(10, 2)
  lunchBreakMinutes   Int       @default(0) @map("lunch_break_minutes")
  lunchDeduction      Int       @default(0) @map("lunch_deduction")
  lunchPenaltyXP      Int       @default(0) @map("lunch_penalty_xp")
  userRole            String    @map("user_role")
  dailyRate           Decimal   @map("daily_rate") @db.Decimal(10, 2)
  hourlyRate          Decimal   @map("hourly_rate") @db.Decimal(10, 2)
  overtimeRate        Decimal   @map("overtime_rate") @db.Decimal(10, 2)
  travelRate          Decimal?  @map("travel_rate") @db.Decimal(10, 2)
  totalPayment        Decimal   @default(0) @map("total_payment") @db.Decimal(10, 2)
  hasDistantCheckins  Boolean   @default(false) @map("has_distant_checkins")
  distantCheckinCount Int       @default(0) @map("distant_checkin_count")
  processedAt         DateTime? @map("processed_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@unique([userId, workDate])
  @@index([userId, workDate])
  @@index([workDate])
  @@map("daily_work_summaries")
}

model LunchBreakAlert {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  checkinId    String    @map("checkin_id")
  alertNumber  Int       @map("alert_number")
  alertTime    String    @map("alert_time")
  scheduledFor DateTime  @map("scheduled_for")
  sentAt       DateTime? @map("sent_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([userId, scheduledFor])
  @@index([checkinId])
  @@map("lunch_break_alerts")
}

model Upload {
  id        String     @id @default(uuid())
  filename  String
  mimetype  String
  size      Int
  data      Bytes
  type      UploadType @default(OTHER)
  userId    String?    @map("user_id")
  entityId  String?    @map("entity_id")
  createdAt DateTime   @default(now()) @map("created_at")

  @@index([type])
  @@index([userId])
  @@index([entityId])
  @@map("uploads")
}

model EducationalVideo {
  id               String          @id @default(uuid())
  title            String
  description      String?
  videoUrl         String          @map("video_url")
  thumbnailUrl     String?         @map("thumbnail_url")
  durationSeconds  Int             @map("duration_seconds")
  category         VideoCategory   @default(TECNICA)
  level            VideoLevel      @default(INICIANTE)
  sortOrder        Int             @default(0) @map("sort_order")
  isActive         Boolean         @default(true) @map("is_active")
  isRequired       Boolean         @default(false) @map("is_required")
  xpForWatching    Int             @default(0) @map("xp_for_watching")
  viewsCount       Int             @default(0) @map("views_count")
  completionsCount Int             @default(0) @map("completions_count")
  publishedAt      DateTime?       @map("published_at")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  progress         VideoProgress[]
  quiz             VideoQuiz?

  @@index([isActive, category])
  @@index([sortOrder])
  @@map("educational_videos")
}

model VideoQuiz {
  id           String           @id @default(uuid())
  videoId      String           @unique @map("video_id")
  title        String?
  passingScore Int              @default(70) @map("passing_score")
  maxAttempts  Int              @default(3) @map("max_attempts")
  xpReward     Int              @default(100) @map("xp_reward")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  attempts     QuizAttempt[]
  questions    QuizQuestion[]
  video        EducationalVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@map("video_quizzes")
}

model QuizQuestion {
  id           String       @id @default(uuid())
  quizId       String       @map("quiz_id")
  questionText String       @map("question_text")
  questionType QuestionType @default(SINGLE_CHOICE) @map("question_type")
  imageUrl     String?      @map("image_url")
  sortOrder    Int          @default(0) @map("sort_order")
  explanation  String?
  createdAt    DateTime     @default(now()) @map("created_at")
  answers      QuizAnswer[]
  quiz         VideoQuiz    @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId, sortOrder])
  @@map("quiz_questions")
}

model QuizAnswer {
  id         String       @id @default(uuid())
  questionId String       @map("question_id")
  answerText String       @map("answer_text")
  isCorrect  Boolean      @default(false) @map("is_correct")
  sortOrder  Int          @default(0) @map("sort_order")
  question   QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId, sortOrder])
  @@map("quiz_answers")
}

model VideoProgress {
  id              String           @id @default(uuid())
  userId          String           @map("user_id")
  videoId         String           @map("video_id")
  watchedSeconds  Int              @default(0) @map("watched_seconds")
  progressPercent Int              @default(0) @map("progress_percent")
  completed       Boolean          @default(false)
  completedAt     DateTime?        @map("completed_at")
  xpEarnedWatch   Int              @default(0) @map("xp_earned_watch")
  startedAt       DateTime         @default(now()) @map("started_at")
  lastWatchedAt   DateTime         @default(now()) @map("last_watched_at")
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  video           EducationalVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId, completed])
  @@map("video_progress")
}

model QuizAttempt {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  quizId         String    @map("quiz_id")
  score          Int
  passed         Boolean   @default(false)
  correctCount   Int       @map("correct_count")
  totalQuestions Int       @map("total_questions")
  answers        Json
  xpEarned       Int       @default(0) @map("xp_earned")
  startedAt      DateTime  @default(now()) @map("started_at")
  completedAt    DateTime? @map("completed_at")
  quiz           VideoQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, quizId])
  @@index([quizId, passed])
  @@map("quiz_attempts")
}

model PendingNotification {
  id          String                  @id @default(uuid())
  userId      String                  @map("user_id")
  type        PendingNotificationType
  payload     Json
  isDelivered Boolean                 @default(false) @map("is_delivered")
  deliveredAt DateTime?               @map("delivered_at")
  createdAt   DateTime                @default(now()) @map("created_at")
  expiresAt   DateTime?               @map("expires_at")
  user        User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isDelivered])
  @@index([createdAt])
  @@map("pending_notifications")
}

model DailyReportResponsibility {
  id                String                     @id @default(uuid())
  projectId         String                     @map("project_id")
  responsibleUserId String                     @map("responsible_user_id")
  reportDate        DateTime                   @map("report_date") @db.Date
  originalUserId    String?                    @map("original_user_id")
  transferredAt     DateTime?                  @map("transferred_at")
  transferReason    String?                    @map("transfer_reason")
  status            ReportResponsibilityStatus @default(PENDING)
  reportId          String?                    @map("report_id")
  createdAt         DateTime                   @default(now()) @map("created_at")
  notifiedAt        DateTime?                  @map("notified_at")
  originalUser      User?                      @relation("OriginalReportResponsible", fields: [originalUserId], references: [id])
  project           Project                    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsibleUser   User                       @relation("CurrentReportResponsible", fields: [responsibleUserId], references: [id])

  @@unique([projectId, reportDate])
  @@index([responsibleUserId, reportDate])
  @@map("daily_report_responsibilities")
}

model ComercialData {
  id                  String              @id @default(uuid())
  projectId           String?             @unique @map("project_id") // Opcional - s  preenchido quando lead vira projeto
  pipedriveDealId     String?             @unique @map("pipedrive_deal_id")
  pipedrivePersonId   Int?                @map("pipedrive_person_id")
  pipedriveOrgId      Int?                @map("pipedrive_org_id")
  stageId             Int?                @map("stage_id")
  stageName           String?             @map("stage_name")
  stageOrderNr        Int?                @map("stage_order_nr")
  pipelineId          Int?                @map("pipeline_id")
  pipedriveUrl        String?             @map("pipedrive_url")
  personName          String?             @map("person_name")
  personEmail         String?             @map("person_email")
  personPhone         String?             @map("person_phone")
  dealValue           Decimal?            @map("deal_value") @db.Decimal(12, 2)
  dealCurrency        String?             @map("deal_currency")
  probability         Int?
  weightedValue       Decimal?            @map("weighted_value") @db.Decimal(12, 2)
  dealAddTime         DateTime?           @map("deal_add_time")
  dealUpdateTime      DateTime?           @map("deal_update_time")
  stageChangeTime     DateTime?           @map("stage_change_time")
  wonTime             DateTime?           @map("won_time")
  lostTime            DateTime?           @map("lost_time")
  expectedCloseDate   DateTime?           @map("expected_close_date")
  dealStatus          String?             @map("deal_status")
  lostReason          String?             @map("lost_reason")
  filesCount          Int?                @default(0) @map("files_count")
  notesCount          Int?                @default(0) @map("notes_count")
  activitiesCount     Int?                @default(0) @map("activities_count")
  followersCount      Int?                @default(0) @map("followers_count")
  emailMessagesCount  Int?                @default(0) @map("email_messages_count")
  ownerUserId         Int?                @map("owner_user_id")
  ownerUserName       String?             @map("owner_user_name")
  ownerUserEmail      String?             @map("owner_user_email")
  creatorUserId       Int?                @map("creator_user_id")
  creatorUserName     String?             @map("creator_user_name")
  resumo              String?
  metragemEstimada    String?             @map("metragem_estimada")
  metragemEstimadaN1  String?             @map("metragem_estimada_n1")
  descritivoArea      String?             @map("descritivo_area")
  detalhesArquiteto   String?             @map("detalhes_arquiteto")
  cidadeExecucaoDesc  String?             @map("cidade_execucao_desc")
  cidadeExecucao      String?             @map("cidade_execucao")
  tipoCliente         String?             @map("tipo_cliente")
  tipoProjeto         String?             @map("tipo_projeto")
  nomeEscritorio      String?             @map("nome_escritorio")
  budgetEstimado      String?             @map("budget_estimado")
  estadoObra          String?             @map("estado_obra")
  metragemSemArq      String?             @map("metragem_sem_arq")
  dataPrevistaExec    String?             @map("data_prevista_exec")
  primeiroNomeZapi    String?             @map("primeiro_nome_zapi")
  telefoneZapi        String?             @map("telefone_zapi")
  labelPipedrive      String?             @map("label_pipedrive")
  dealOrigin          String?             @map("deal_origin")
  dealOriginId        String?             @map("deal_origin_id")
  pipedriveRawData    Json?               @map("pipedrive_raw_data")
  origem              String?
  arquiteto           String?
  escritorio          String?
  telefoneArquiteto   String?             @map("telefone_arquiteto")
  status              ComercialStatus     @default(LEAD)
  motivoPerda         String?             @map("motivo_perda")
  dataGanho           DateTime?           @map("data_ganho")
  dataPerda           DateTime?           @map("data_perda")
  consultorId         String?             @map("consultor_id")
  pipedriveSyncedAt   DateTime?           @map("pipedrive_synced_at")
  typeformResponseId  String?             @unique @map("typeform_response_id")
  typeformSubmittedAt DateTime?           @map("typeform_submitted_at")
  typeformRawData     Json?               @map("typeform_raw_data")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  project             Project?            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  followUps           FollowUp[]
  pipedriveActivities PipedriveActivity[]
  pipedriveFiles      PipedriveFile[]
  pipedriveNotes      PipedriveNote[]
  propostas           Proposta[]
  anexos              ComercialAnexo[]
  orcamentosEnviados  OrcamentoEnviado[]

  @@index([status])
  @@index([pipedriveDealId])
  @@index([stageId])
  @@index([dealStatus])
  @@map("comercial_data")
}

// Anexos do lead (projeto arquitetnico, documentos, etc)
model ComercialAnexo {
  id           String         @id @default(uuid())
  comercialId  String         @map("comercial_id")
  nome         String         // Nome do arquivo
  tipo         String         // PROJETO_ARQUITETONICO, PLANTA, DOCUMENTO, OUTRO
  descricao    String?        // Descrio opcional
  fileData     String?        @map("file_data") @db.Text // Base64 do arquivo
  fileUrl      String?        @map("file_url") // URL externa (se aplicvel)
  mimeType     String?        @map("mime_type") // image/png, application/pdf, etc
  fileSize     Int?           @map("file_size") // Tamanho em bytes
  createdAt    DateTime       @default(now()) @map("created_at")
  comercial    ComercialData  @relation(fields: [comercialId], references: [id], onDelete: Cascade)

  @@index([comercialId])
  @@map("comercial_anexos")
}

// Oramentos enviados ao cliente com datas
model OrcamentoEnviado {
  id           String         @id @default(uuid())
  comercialId  String         @map("comercial_id")
  dataEnvio    DateTime       @map("data_envio")
  valor        Decimal?       @db.Decimal(12, 2)
  descricao    String?        // Descrio do oramento
  metragem     Decimal?       @db.Decimal(10, 2)
  observacoes  String?        @db.Text
  propostaId   String?        @map("proposta_id") // Vnculo com proposta gerada (opcional)
  createdAt    DateTime       @default(now()) @map("created_at")
  comercial    ComercialData  @relation(fields: [comercialId], references: [id], onDelete: Cascade)
  proposta     Proposta?      @relation(fields: [propostaId], references: [id], onDelete: SetNull)

  @@index([comercialId])
  @@index([dataEnvio])
  @@map("orcamentos_enviados")
}

model PipedriveNote {
  id              String        @id @default(uuid())
  comercialId     String        @map("comercial_id")
  pipedriveNoteId Int           @unique @map("pipedrive_note_id")
  content         String
  addTime         DateTime?     @map("add_time")
  updateTime      DateTime?     @map("update_time")
  userId          Int?          @map("user_id")
  userName        String?       @map("user_name")
  pinned          Boolean       @default(false)
  createdAt       DateTime      @default(now()) @map("created_at")
  comercial       ComercialData @relation(fields: [comercialId], references: [id], onDelete: Cascade)

  @@index([comercialId])
  @@map("pipedrive_notes")
}

model PipedriveActivity {
  id                  String        @id @default(uuid())
  comercialId         String        @map("comercial_id")
  pipedriveActivityId Int           @unique @map("pipedrive_activity_id")
  type                String?
  subject             String?
  note                String?
  dueDate             DateTime?     @map("due_date")
  dueTime             String?       @map("due_time")
  duration            Int?
  done                Boolean       @default(false)
  markedDoneTime      DateTime?     @map("marked_done_time")
  userId              Int?          @map("user_id")
  userName            String?       @map("user_name")
  addTime             DateTime?     @map("add_time")
  createdAt           DateTime      @default(now()) @map("created_at")
  comercial           ComercialData @relation(fields: [comercialId], references: [id], onDelete: Cascade)

  @@index([comercialId])
  @@map("pipedrive_activities")
}

model PipedriveFile {
  id              String        @id @default(uuid())
  comercialId     String        @map("comercial_id")
  pipedriveFileId Int           @unique @map("pipedrive_file_id")
  fileName        String        @map("file_name")
  fileType        String?       @map("file_type")
  fileSize        Int?          @map("file_size")
  fileUrl         String?       @map("file_url")
  addTime         DateTime?     @map("add_time")
  userId          Int?          @map("user_id")
  userName        String?       @map("user_name")
  createdAt       DateTime      @default(now()) @map("created_at")
  comercial       ComercialData @relation(fields: [comercialId], references: [id], onDelete: Cascade)

  @@index([comercialId])
  @@map("pipedrive_files")
}

model Proposta {
  id             String         @id @default(uuid())
  comercialId    String         @map("comercial_id")
  versao         Int            @default(1)
  valorTotal     Decimal        @map("valor_total") @db.Decimal(12, 2)
  valorM2        Decimal?       @map("valor_m2") @db.Decimal(10, 2)
  desconto       Decimal?       @db.Decimal(5, 2)
  descricao      String?
  escopoUrl      String?        @map("escopo_url")
  pdfUrl         String?        @map("pdf_url") // URL do PDF gerado
  pdfBase64      String?        @map("pdf_base64") @db.Text // PDF em base64 para envio direto
  metragem       Decimal?       @db.Decimal(10, 2) // Metragem total
  dadosCalculo   Json?          @map("dados_calculo") // Dados usados no clculo
  status         PropostaStatus @default(DRAFT)
  enviadaEm      DateTime?      @map("enviada_em")
  aprovadaEm     DateTime?      @map("aprovada_em")
  rejeitadaEm    DateTime?      @map("rejeitada_em")
  motivoRejeicao String?        @map("motivo_rejeicao")
  validadeAte    DateTime?      @map("validade_ate")
  // Campos para proposta HTML com tracking
  htmlSlug       String?        @unique @map("html_slug") // Slug nico para URL pblica
  htmlContent    String?        @map("html_content") @db.Text // Contedo HTML da proposta
  htmlImages     String?        @map("html_images") @db.Text // Imagens pr-convertidas (JSON array)
  htmlGeradoEm   DateTime?      @map("html_gerado_em") // Quando foi gerada em HTML
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  comercial          ComercialData    @relation(fields: [comercialId], references: [id], onDelete: Cascade)
  orcamentosEnviados OrcamentoEnviado[]
  views              PropostaView[]

  @@index([comercialId])
  @@index([status])
  @@index([htmlSlug])
  @@map("propostas")
}

// Modelo para tracking de visualizaes de propostas HTML
model PropostaView {
  id            String   @id @default(uuid())
  propostaId    String   @map("proposta_id")
  viewedAt      DateTime @default(now()) @map("viewed_at")
  ip            String?  // IP do visitante
  userAgent     String?  @map("user_agent") @db.Text // User agent do navegador
  country       String?  // Pas (geolocalizao por IP)
  city          String?  // Cidade
  region        String?  // Estado/Regio
  timeOnPage    Int?     @map("time_on_page") // Tempo na pgina em segundos
  scrollDepth   Int?     @map("scroll_depth") // Profundidade de scroll (0-100%)
  deviceType    String?  @map("device_type") // mobile, tablet, desktop
  isBot         Boolean  @default(false) @map("is_bot") // Se detectou como bot
  sessionId     String?  @map("session_id") // ID da sesso para agrupar eventos
  proposta      Proposta @relation(fields: [propostaId], references: [id], onDelete: Cascade)

  @@index([propostaId])
  @@index([viewedAt])
  @@index([ip])
  @@map("proposta_views")
}

model FollowUp {
  id           String         @id @default(uuid())
  comercialId  String         @map("comercial_id")
  tipo         FollowUpTipo
  canal        FollowUpCanal  @default(WHATSAPP)
  mensagem     String?
  resultado    String?
  agendadoPara DateTime?      @map("agendado_para")
  realizadoEm  DateTime?      @map("realizado_em")
  status       FollowUpStatus @default(AGENDADO)
  createdAt    DateTime       @default(now()) @map("created_at")
  comercial    ComercialData  @relation(fields: [comercialId], references: [id], onDelete: Cascade)

  @@index([comercialId])
  @@index([agendadoPara, status])
  @@map("follow_ups")
}

model Contrato {
  id                   String         @id @default(uuid())
  projectId            String         @unique @map("project_id")
  numero               String?        @unique
  valorContratado      Decimal        @map("valor_contratado") @db.Decimal(12, 2)
  valorEntrada         Decimal?       @map("valor_entrada") @db.Decimal(12, 2)
  formaPagamento       String?        @map("forma_pagamento")
  escopoInicialUrl     String?        @map("escopo_inicial_url")
  escopoAprovadoUrl    String?        @map("escopo_aprovado_url")
  m2Piso               Decimal?       @map("m2_piso") @db.Decimal(10, 2)
  m2Parede             Decimal?       @map("m2_parede") @db.Decimal(10, 2)
  m2Rodape             Decimal?       @map("m2_rodape") @db.Decimal(10, 2)
  cores                String[]
  materiais            String[]
  isTelada             Boolean        @default(false) @map("is_telada")
  isFaseada            Boolean        @default(false) @map("is_faseada")
  detalheFaseamento    String?        @map("detalhe_faseamento")
  detalheTela          String?        @map("detalhe_tela")
  aprovadoInternamente Boolean        @default(false) @map("aprovado_internamente")
  aprovadoCliente      Boolean        @default(false) @map("aprovado_cliente")
  assinadoDigitalmente Boolean        @default(false) @map("assinado_digitalmente")
  dataAprovacaoInterna DateTime?      @map("data_aprovacao_interna")
  dataAprovacaoCliente DateTime?      @map("data_aprovacao_cliente")
  dataAssinatura       DateTime?      @map("data_assinatura")
  status               ContratoStatus @default(DRAFT)
  consultorContratoId  String?        @map("consultor_contrato_id")
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")
  project              Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parcelas             Parcela[]

  @@index([status])
  @@map("contratos")
}

model Parcela {
  id            String    @id @default(uuid())
  contratoId    String    @map("contrato_id")
  numero        Int
  valor         Decimal   @db.Decimal(12, 2)
  vencimento    DateTime  @db.Date
  descricao     String?
  pago          Boolean   @default(false)
  dataPagamento DateTime? @map("data_pagamento")
  comprovante   String?
  createdAt     DateTime  @default(now()) @map("created_at")
  contrato      Contrato  @relation(fields: [contratoId], references: [id], onDelete: Cascade)

  @@index([contratoId])
  @@index([vencimento, pago])
  @@map("parcelas")
}

model Planejamento {
  id                      String             @id @default(uuid())
  projectId               String             @unique @map("project_id")
  pipefyCardId            String?            @unique @map("pipefy_card_id")
  pipefyPhaseId           String?            @map("pipefy_phase_id")
  pipefyPhaseName         String?            @map("pipefy_phase_name")
  pipefyUrl               String?            @map("pipefy_url")
  pipefySyncedAt          DateTime?          @map("pipefy_synced_at")
  pipefyCreatedAt         DateTime?          @map("pipefy_created_at")
  status                  PlanejamentoStatus @default(ENTRADA)
  isReserva               Boolean            @default(false) @map("is_reserva")
  dataEntrada             DateTime?          @map("data_entrada")
  dataDueDate             DateTime?          @map("data_due_date")
  dataUltimaCamadaVerniz  DateTime?          @map("data_ultima_camada_verniz")
  m2Total                 Decimal?           @map("m2_total") @db.Decimal(10, 2)
  metragemLinearTotal     Decimal?           @map("metragem_linear_total") @db.Decimal(10, 2)
  prazoEstimado           Int?               @map("prazo_estimado")
  visitaAntesPiui         Boolean            @default(false) @map("visita_antes_piui")
  isTelada                Boolean            @default(false) @map("is_telada")
  detalheTela             String?            @map("detalhe_tela")
  isFaseada               Boolean            @default(false) @map("is_faseada")
  detalheFaseamento       String?            @map("detalhe_faseamento")
  classificacaoSuperficie String[]           @map("classificacao_superficie")
  cores                   String[]
  detalhePersonalizacao   String?            @map("detalhe_personalizacao")
  materiais               String[]
  etiquetas               String[]
  equipeExecucao          String?            @map("equipe_execucao")
  numeroOS                Int?               @map("numero_os")
  vendedor                String?
  consultorOperacional    String?            @map("consultor_operacional")
  consultorOperacionalId  String?            @map("consultor_operacional_id")
  consultorAtendimento    String?            @map("consultor_atendimento")
  consultorAtendimentoId  String?            @map("consultor_atendimento_id")
  consultorProjetos       String?            @map("consultor_projetos")
  consultorProjetosId     String?            @map("consultor_projetos_id")
  escopoInicialUrl        String?            @map("escopo_inicial_url")
  escopoAprovadoUrl       String?            @map("escopo_aprovado_url")
  vtAfericaoRealizada     Boolean            @default(false) @map("vt_afericao_realizada")
  projetoRevisado         Boolean            @default(false) @map("projeto_revisado")
  confirmacoesOk          Boolean            @default(false) @map("confirmacoes_ok")
  equipeDefinida          Boolean            @default(false) @map("equipe_definida")
  materialProduzido       Boolean            @default(false) @map("material_produzido")
  materialEntregue        Boolean            @default(false) @map("material_entregue")
  observacoes             String?
  pipefyRawData           Json?              @map("pipefy_raw_data")
  createdAt               DateTime           @default(now()) @map("created_at")
  updatedAt               DateTime           @updatedAt @map("updated_at")
  logistica               Logistica?
  ordemServico            OrdemServico?
  pipefyAttachments       PipefyAttachment[]
  pipefyComments          PipefyComment[]
  project                 Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  visitasTecnicas         VisitaTecnica[]

  @@index([status])
  @@index([pipefyCardId])
  @@index([pipefyPhaseName])
  @@map("planejamentos")
}

model PipefyComment {
  id              String       @id @default(uuid())
  planejamentoId  String       @map("planejamento_id")
  pipefyCommentId String?      @map("pipefy_comment_id")
  text            String
  authorName      String?      @map("author_name")
  createdAt       DateTime     @map("pipefy_created_at")
  planejamento    Planejamento @relation(fields: [planejamentoId], references: [id], onDelete: Cascade)

  @@index([planejamentoId])
  @@map("pipefy_comments")
}

model PipefyAttachment {
  id             String       @id @default(uuid())
  planejamentoId String       @map("planejamento_id")
  pipefyPath     String?      @map("pipefy_path")
  url            String
  fieldName      String?      @map("field_name")
  createdAt      DateTime     @default(now()) @map("created_at")
  planejamento   Planejamento @relation(fields: [planejamentoId], references: [id], onDelete: Cascade)

  @@index([planejamentoId])
  @@map("pipefy_attachments")
}

model VisitaTecnica {
  id               String       @id @default(uuid())
  planejamentoId   String       @map("planejamento_id")
  tipo             TipoVisita
  status           VisitaStatus @default(AGENDADA)
  dataAgendada     DateTime?    @map("data_agendada")
  dataRealizada    DateTime?    @map("data_realizada")
  observacoes      String?
  relatorioUrl     String?      @map("relatorio_url")
  fotos            String[]
  realizadaPorId   String?      @map("realizada_por_id")
  realizadaPorNome String?      @map("realizada_por_nome")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  planejamento     Planejamento @relation(fields: [planejamentoId], references: [id], onDelete: Cascade)

  @@index([planejamentoId])
  @@index([dataAgendada, status])
  @@map("visitas_tecnicas")
}

model OrdemServico {
  id             String       @id @default(uuid())
  planejamentoId String       @unique @map("planejamento_id")
  numero         String       @unique
  status         OSStatus     @default(AGUARDANDO)
  dataEnvio      DateTime?    @map("data_envio")
  dataPrevisao   DateTime?    @map("data_previsao")
  dataConclusao  DateTime?    @map("data_conclusao")
  cores          String[]
  materiais      String[]
  quantidades    Json?
  observacoes    String?
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  planejamento   Planejamento @relation(fields: [planejamentoId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("ordens_servico")
}

model Logistica {
  id                   String          @id @default(uuid())
  planejamentoId       String          @unique @map("planejamento_id")
  dataEntregaAgendada  DateTime?       @map("data_entrega_agendada")
  dataEntregaRealizada DateTime?       @map("data_entrega_realizada")
  entregaConfirmada    Boolean         @default(false) @map("entrega_confirmada")
  entregaFotos         String[]        @map("entrega_fotos")
  dataColetaAgendada   DateTime?       @map("data_coleta_agendada")
  dataColetaRealizada  DateTime?       @map("data_coleta_realizada")
  coletaConfirmada     Boolean         @default(false) @map("coleta_confirmada")
  coletaFotos          String[]        @map("coleta_fotos")
  observacoesEntrega   String?         @map("observacoes_entrega")
  observacoesColeta    String?         @map("observacoes_coleta")
  status               LogisticaStatus @default(AGUARDANDO)
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")
  planejamento         Planejamento    @relation(fields: [planejamentoId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("logisticas")
}

model Execucao {
  id               String               @id @default(uuid())
  projectId        String               @unique @map("project_id")
  status           ExecucaoStatus       @default(AGUARDANDO)
  dataInicio       DateTime?            @map("data_inicio")
  dataFim          DateTime?            @map("data_fim")
  m2Executado      Decimal              @default(0) @map("m2_executado") @db.Decimal(10, 2)
  percentual       Int                  @default(0)
  horasTrabalhadas Decimal              @default(0) @map("horas_trabalhadas") @db.Decimal(10, 2)
  dataUltimoVerniz DateTime?            @map("data_ultimo_verniz")
  observacoes      String?
  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")
  checklists       ChecklistQualidade[]
  etapas           EtapaExecucao[]
  project          Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("execucoes")
}

model EtapaExecucao {
  id          String      @id @default(uuid())
  execucaoId  String      @map("execucao_id")
  nome        String
  descricao   String?
  ordem       Int
  m2Estimado  Decimal?    @map("m2_estimado") @db.Decimal(10, 2)
  m2Executado Decimal     @default(0) @map("m2_executado") @db.Decimal(10, 2)
  status      EtapaStatus @default(PENDENTE)
  dataInicio  DateTime?   @map("data_inicio")
  dataFim     DateTime?   @map("data_fim")
  fotoBefore  String?     @map("foto_before")
  fotoAfter   String?     @map("foto_after")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  execucao    Execucao    @relation(fields: [execucaoId], references: [id], onDelete: Cascade)

  @@index([execucaoId, ordem])
  @@map("etapas_execucao")
}

model ChecklistQualidade {
  id              String    @id @default(uuid())
  execucaoId      String    @map("execucao_id")
  etapa           String
  items           Json
  aprovado        Boolean   @default(false)
  aprovadoPorId   String?   @map("aprovado_por_id")
  aprovadoPorNome String?   @map("aprovado_por_nome")
  aprovadoEm      DateTime? @map("aprovado_em")
  observacoes     String?
  fotos           String[]
  createdAt       DateTime  @default(now()) @map("created_at")
  execucao        Execucao  @relation(fields: [execucaoId], references: [id], onDelete: Cascade)

  @@index([execucaoId])
  @@map("checklists_qualidade")
}

model PosVenda {
  id                String            @id @default(uuid())
  projectId         String            @map("project_id")
  dataAcionamento   DateTime          @default(now()) @map("data_acionamento")
  motivoAcionamento String            @map("motivo_acionamento")
  prioridade        Prioridade        @default(MEDIA)
  contatoCliente    String?           @map("contato_cliente")
  telefoneContato   String?           @map("telefone_contato")
  status            PosVendaStatus    @default(ABERTO)
  dataResolucao     DateTime?         @map("data_resolucao")
  observacoesFinais String?           @map("observacoes_finais")
  responsavelId     String?           @map("responsavel_id")
  responsavelNome   String?           @map("responsavel_nome")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  intervencao       Intervencao?
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  visitasQualidade  VisitaQualidade[]

  @@index([projectId])
  @@index([status])
  @@map("pos_vendas")
}

model VisitaQualidade {
  id                   String       @id @default(uuid())
  posVendaId           String       @map("pos_venda_id")
  dataAgendada         DateTime?    @map("data_agendada")
  dataRealizada        DateTime?    @map("data_realizada")
  status               VisitaStatus @default(AGENDADA)
  parecer              String?
  problemasEncontrados String[]     @map("problemas_encontrados")
  recomendacoes        String?
  fotos                String[]
  realizadaPorId       String?      @map("realizada_por_id")
  realizadaPorNome     String?      @map("realizada_por_nome")
  createdAt            DateTime     @default(now()) @map("created_at")
  posVenda             PosVenda     @relation(fields: [posVendaId], references: [id], onDelete: Cascade)

  @@index([posVendaId])
  @@map("visitas_qualidade")
}

model Intervencao {
  id              String            @id @default(uuid())
  posVendaId      String            @unique @map("pos_venda_id")
  descricao       String
  m2Intervencao   Decimal?          @map("m2_intervencao") @db.Decimal(10, 2)
  status          IntervencaoStatus @default(PLANEJANDO)
  dataInicio      DateTime?         @map("data_inicio")
  dataFim         DateTime?         @map("data_fim")
  custoEstimado   Decimal?          @map("custo_estimado") @db.Decimal(12, 2)
  custoReal       Decimal?          @map("custo_real") @db.Decimal(12, 2)
  cobradoCliente  Boolean           @default(false) @map("cobrado_cliente")
  equipeDesignada String?           @map("equipe_designada")
  relatorioFinal  String?           @map("relatorio_final")
  fotos           String[]
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  posVenda        PosVenda          @relation(fields: [posVendaId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("intervencoes")
}

model TimelineEvent {
  id              String        @id @default(uuid())
  projectId       String        @map("project_id")
  modulo          ProjectModule
  tipo            String
  subtipo         String?
  titulo          String
  descricao       String?
  dadosAnteriores Json?         @map("dados_anteriores")
  dadosNovos      Json?         @map("dados_novos")
  metadata        Json?
  userId          String?       @map("user_id")
  userName        String?       @map("user_name")
  adminId         String?       @map("admin_id")
  adminName       String?       @map("admin_name")
  createdAt       DateTime      @default(now()) @map("created_at")
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt])
  @@index([modulo])
  @@map("timeline_events")
}

model ProjectVideo {
  id              String        @id @default(uuid())
  projectId       String        @map("project_id")
  titulo          String
  descricao       String?
  url             String
  thumbnailUrl    String?       @map("thumbnail_url")
  duracaoSegundos Int?          @map("duracao_segundos")
  tipo            VideoTipo
  fase            ProjectModule
  ordem           Int           @default(0)
  createdAt       DateTime      @default(now()) @map("created_at")
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, fase])
  @@map("project_videos")
}

model PipelineStage {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  color        String   @default("#6366f1")
  icon         String?
  probability  Int      @default(50)
  groupName    String   @map("group_name")
  groupColor   String?  @map("group_color")
  sortOrder    Int      @default(0) @map("sort_order")
  isActive     Boolean  @default(true) @map("is_active")
  isSystem     Boolean  @default(false) @map("is_system")
  isFinal      Boolean  @default(false) @map("is_final")
  isWon        Boolean  @default(false) @map("is_won")
  autoMoveDays Int?     @map("auto_move_days")
  autoMoveToId String?  @map("auto_move_to_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([groupName, sortOrder])
  @@index([isActive])
  @@map("pipeline_stages")
}

model LeadScoringRule {
  id          String   @id @default(uuid())
  name        String
  description String?
  category    String
  condition   Json
  points      Int      @default(10)
  maxPoints   Int?     @map("max_points")
  isActive    Boolean  @default(true) @map("is_active")
  priority    Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category, isActive])
  @@map("lead_scoring_rules")
}

model LeadScoreHistory {
  id              String   @id @default(uuid())
  comercialId     String   @map("comercial_id")
  totalScore      Int      @map("total_score")
  fitScore        Int      @map("fit_score")
  engagementScore Int      @map("engagement_score")
  behaviorScore   Int      @map("behavior_score")
  timeScore       Int      @map("time_score")
  rulesApplied    Json     @map("rules_applied")
  calculatedAt    DateTime @default(now()) @map("calculated_at")

  @@index([comercialId, calculatedAt])
  @@map("lead_score_history")
}

model CRMAutomation {
  id             String          @id @default(uuid())
  name           String
  description    String?
  isActive       Boolean         @default(true) @map("is_active")
  triggerType    String          @map("trigger_type")
  triggerConfig  Json            @map("trigger_config")
  conditions     Json[]          @default([])
  actions        Json[]          @default([])
  executionCount Int             @default(0) @map("execution_count")
  lastExecutedAt DateTime?       @map("last_executed_at")
  lastError      String?         @map("last_error")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  logs           AutomationLog[]

  @@index([isActive, triggerType])
  @@map("crm_automations")
}

model AutomationLog {
  id              String        @id @default(uuid())
  automationId    String        @map("automation_id")
  comercialId     String?       @map("comercial_id")
  triggeredBy     String        @map("triggered_by")
  status          String
  actionsExecuted Json          @map("actions_executed")
  errorMessage    String?       @map("error_message")
  executedAt      DateTime      @default(now()) @map("executed_at")
  durationMs      Int?          @map("duration_ms")
  automation      CRMAutomation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId, executedAt])
  @@index([comercialId])
  @@map("automation_logs")
}

model WhatsAppTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  content     String
  category    String   @default("general")
  isActive    Boolean  @default(true) @map("is_active")
  usageCount  Int      @default(0) @map("usage_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category, isActive])
  @@map("whatsapp_templates")
}

model WhatsAppMessageLog {
  id            String    @id @default(uuid())
  comercialId   String?   @map("comercial_id")
  templateId    String?   @map("template_id")
  phoneNumber   String    @map("phone_number")
  recipientName String?   @map("recipient_name")
  message       String
  status        String    @default("pending")
  zapiMessageId String?   @map("zapi_message_id")
  errorMessage  String?   @map("error_message")
  sentAt        DateTime  @default(now()) @map("sent_at")
  deliveredAt   DateTime? @map("delivered_at")
  readAt        DateTime? @map("read_at")

  @@index([comercialId])
  @@index([status, sentAt])
  @@map("whatsapp_message_logs")
}

model Holiday {
  id          String      @id @default(uuid())
  date        DateTime    @db.Date
  year        Int?
  name        String
  description String?
  type        HolidayType @default(NATIONAL)
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@unique([date, year])
  @@index([date])
  @@map("holidays")
}

model SaturdaySchedule {
  id             String         @id @default(uuid())
  date           DateTime       @db.Date
  projectId      String?        @map("project_id")
  userId         String         @map("user_id")
  status         ScheduleStatus @default(SCHEDULED)
  confirmedAt    DateTime?      @map("confirmed_at")
  declinedAt     DateTime?      @map("declined_at")
  declineReason  String?        @map("decline_reason")
  checkinId      String?        @map("checkin_id")
  notifiedAt     DateTime?      @map("notified_at")
  reminderSentAt DateTime?      @map("reminder_sent_at")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  project        Project?       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([date, userId])
  @@index([date])
  @@index([userId, date])
  @@index([status])
  @@map("saturday_schedules")
}

model WorkDayResponse {
  id             String   @id @default(uuid())
  date           DateTime @db.Date
  userId         String   @map("user_id")
  dayType        DayType  @map("day_type")
  willWork       Boolean  @map("will_work")
  respondedAt    DateTime @default(now()) @map("responded_at")
  reason         String?
  actuallyWorked Boolean? @map("actually_worked")
  checkinId      String?  @map("checkin_id")
  createdAt      DateTime @default(now()) @map("created_at")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([date, userId])
  @@index([date])
  @@index([userId, date])
  @@map("work_day_responses")
}

model AbsenceRecord {
  id                 String      @id @default(uuid())
  date               DateTime    @db.Date
  userId             String      @map("user_id")
  type               AbsenceType
  saturdayScheduleId String?     @map("saturday_schedule_id")
  projectId          String?     @map("project_id")
  xpPenalty          Int         @default(0) @map("xp_penalty")
  penaltyApplied     Boolean     @default(false) @map("penalty_applied")
  penaltyAppliedAt   DateTime?   @map("penalty_applied_at")
  justified          Boolean     @default(false)
  justification      String?
  justifiedAt        DateTime?   @map("justified_at")
  justifiedById      String?     @map("justified_by_id")
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([date, userId, type])
  @@index([userId, date])
  @@index([type, penaltyApplied])
  @@map("absence_records")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

enum UserStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SUSPENDED
}

enum UserRole {
  AUXILIAR
  PREPARADOR
  LIDER_PREPARACAO
  APLICADOR_I
  APLICADOR_II
  APLICADOR_III
  LIDER
}

enum ProjectStatus {
  EM_EXECUCAO
  PAUSADO
  CONCLUIDO
  CANCELADO
}

enum TeamStatus {
  AGUARDANDO_EQUIPE
  EQUIPE_DEFINIDA
  EQUIPE_INCOMPLETA
}

enum ProjectRole {
  AUXILIAR
  PREPARADOR
  LIDER_PREPARACAO
  APLICADOR_I
  APLICADOR_II
  APLICADOR_III
  LIDER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum CheckoutReason {
  FIM_EXPEDIENTE
  OUTRO_PROJETO
  COMPRA_INSUMOS
  ALMOCO_INTERVALO
  AUTO_DISTANTE
  GPS_DESATIVADO
  INATIVIDADE
}

enum ReportType {
  DAILY
  PERIOD
  INCIDENT
}

enum ReportStatus {
  DRAFT
  SUBMITTED
  PROCESSED
}

enum DocumentType {
  ESCOPO
  PLANTA
  CONTRATO
  OUTROS
}

enum GeneratedReportType {
  DAILY
  PERIOD
  CUSTOM
}

enum ContributionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum HelpRequestType {
  MATERIAL
  HELP
}

enum HelpRequestStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  CANCELLED
}

enum CampaignType {
  CHALLENGE
  MULTIPLIER
  BONUS
}

enum BadgeCategory {
  CAMPAIGN
  ACHIEVEMENT
  SPECIAL
  ROLE
}

enum BadgeRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  ENDED
  CANCELLED
}

enum TaskType {
  PREPARACAO
  LIMPEZA_INICIAL
  NIVELAMENTO
  APLICACAO_PISO
  APLICACAO_PAREDE
  APLICACAO_TETO
  RODAPE
  LIXAMENTO
  SELADOR
  CURA
  ACABAMENTO_FINAL
  INSPECAO
  RETRABALHO
  CUSTOM
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
  CANCELLED
}

enum TaskPhase {
  PREPARO
  APLICACAO
  ACABAMENTO
}

enum TaskSurface {
  PISO
  PAREDE
  GERAL
}

enum TaskCompletionType {
  INTEGRAL
  PARTIAL
}

enum VideoJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum XpTransactionType {
  CHECKIN
  CHECKOUT
  REPORT
  CAMPAIGN
  ACHIEVEMENT
  BONUS
  VIDEO_WATCHED
  PENALTY
  TASK_COMPLETED
  QUIZ_PASSED
  LUNCH_SKIPPED
}

enum ReminderStatus {
  PENDING
  SENT
  COMPLETED
  EXPIRED
}

enum AbsenceNoticeType {
  ADVANCE
  SAME_DAY
}

enum AbsenceStatus {
  CONFIRMED
  CANCELLED
}

enum UnreportedAbsenceStatus {
  PENDING
  CONFIRMED
  DENIED
  EXPIRED
}

enum UploadType {
  PROFILE_PHOTO
  DOCUMENT
  BADGE
  CAMPAIGN
  FEED
  REPORT
  NOTIFICATION
  HELP_REQUEST
  OTHER
  EDUCATIONAL_VIDEO
}

enum VideoCategory {
  TECNICA
  SEGURANCA
  PRODUTO
  ATENDIMENTO
  GERAL
}

enum VideoLevel {
  INICIANTE
  INTERMEDIARIO
  AVANCADO
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TRUE_FALSE
}

enum PendingNotificationType {
  ROLE_PROMOTION
  ROLE_DEMOTION
  CONTRIBUTION_APPROVED
  CONTRIBUTION_REJECTED
  PROJECT_ASSIGNED
  XP_PENALTY
  ADMIN_NOTIFICATION
  NOTIFICATION
  CAMPAIGN
  LUNCH_SKIPPED
  REPORT_RESPONSIBILITY_ASSIGNED
  REPORT_RESPONSIBILITY_RECEIVED
}

enum ReportResponsibilityStatus {
  PENDING
  TRANSFERRED
  COMPLETED
  EXPIRED
}

enum ComercialStatus {
  FORM_ORCAMENTO
  LEAD
  QUALIFICACAO
  PRIMEIRO_CONTATO
  CONTATO_ARQUITETO
  AGUARDANDO_ARQ
  LEVANTAMENTO
  VISITA_AGENDADA
  VISITA_REALIZADA
  PROPOSTA_EM_ELABORACAO
  PROPOSTA_ENVIADA
  FOLLOW_UP
  FOLLOW_1
  FOLLOW_2
  FOLLOW_3
  FOLLOW_4
  FOLLOW_5
  NEGOCIACAO
  AJUSTE_PROPOSTA
  GANHO
  PERDIDO
  CONGELADO
}

enum PropostaStatus {
  DRAFT
  ENVIADA
  VISUALIZADA
  APROVADA
  REJEITADA
  EXPIRADA
}

enum FollowUpTipo {
  PRIMEIRO_CONTATO
  FOLLOW_1
  FOLLOW_2
  FOLLOW_3
  NEGOCIACAO
  FECHAMENTO
  OUTRO
}

enum FollowUpCanal {
  WHATSAPP
  EMAIL
  TELEFONE
  PRESENCIAL
}

enum FollowUpStatus {
  AGENDADO
  REALIZADO
  CANCELADO
  REAGENDADO
}

enum ContratoStatus {
  DRAFT
  AGUARDANDO_APROVACAO
  APROVADO_INTERNO
  ENVIADO_CLIENTE
  APROVADO
  ASSINADO
  CANCELADO
}

enum PlanejamentoStatus {
  ENTRADA
  EM_CONTRATO
  PRIMEIRO_CONTATO_OP
  AGEND_VT_AFERICAO
  RESULTADO_VT_AFERICAO
  PROJETOS_REVISAO
  CONFIRMACOES_OP1
  DATA_A_DEFINIR
  AGEND_VT_ACOMPANHAMENTO
  RESULTADO_VT_ACOMPANHAMENTO
  CONFIRMACOES_OP2
  REVISAO_FINAL_OP
  AGUARDANDO_LIBERACAO
  INDUSTRIA_PRODUCAO
  AGEND_VT_ENTRADA
  RESULTADO_VT_ENTRADA
  FINANCEIRO_REVISAO
  EQUIPE_EXECUCAO
  INFO_LOGISTICAS
  LOGISTICA_ENTREGA
  LOGISTICA_MATERIAL_ENTREGUE
  OBRA_EXECUCAO
  OBRA_PAUSADA
  OBRA_CONCLUIDA
  LOGISTICA_COLETAR
  LOGISTICA_EM_COLETA
  CLIENTE_FINALIZADO
}

enum TipoVisita {
  AFERICAO
  ORIENTACAO
  ACOMPANHAMENTO
  ENTRADA
  QUALIDADE
}

enum VisitaStatus {
  AGENDADA
  REALIZADA
  CANCELADA
  REAGENDADA
}

enum OSStatus {
  AGUARDANDO
  ENVIADA
  EM_PRODUCAO
  CONCLUIDA
  CANCELADA
}

enum LogisticaStatus {
  AGUARDANDO
  ENTREGA_AGENDADA
  EM_ENTREGA
  ENTREGUE
  COLETA_AGENDADA
  EM_COLETA
  COLETADO
}

enum ExecucaoStatus {
  AGUARDANDO
  EM_ANDAMENTO
  PAUSADA
  CONCLUIDA
}

enum EtapaStatus {
  PENDENTE
  EM_ANDAMENTO
  CONCLUIDA
  PAUSADA
}

enum PosVendaStatus {
  ABERTO
  VISITA_AGENDADA
  EM_ANALISE
  INTERVENCAO_NECESSARIA
  EM_INTERVENCAO
  RESOLVIDO
  CANCELADO
}

enum Prioridade {
  BAIXA
  MEDIA
  ALTA
  URGENTE
}

enum IntervencaoStatus {
  PLANEJANDO
  AGUARDANDO_MATERIAL
  AGUARDANDO_EQUIPE
  EM_EXECUCAO
  CONCLUIDA
  CANCELADA
}

enum ProjectModule {
  COMERCIAL
  PIUI
  PLANEJAMENTO
  EXECUCAO
  FINALIZADO
  POS_VENDA
}

enum VideoTipo {
  VISITA_INICIAL
  DURANTE_EXECUCAO
  ENTREGA
  POS_VENDA
  DEPOIMENTO
  OUTRO
}

enum HolidayType {
  NATIONAL
  STATE
  MUNICIPAL
  COMPANY
}

enum ScheduleStatus {
  SCHEDULED
  CONFIRMED
  DECLINED
  WORKED
  NO_SHOW
  EXCUSED
}

enum DayType {
  SUNDAY
  SATURDAY
  HOLIDAY
}

enum AbsenceType {
  SATURDAY_NO_SHOW
  WEEKDAY_NO_SHOW
  CONFIRMED_NO_SHOW
  EARLY_LEAVE
  LATE_ARRIVAL
}
