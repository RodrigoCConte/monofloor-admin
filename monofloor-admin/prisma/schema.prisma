generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// ADMIN USERS (Usu√°rios do painel admin)
// =============================================
model AdminUser {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  role          AdminRole @default(ADMIN)
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  approvedUsers      User[]              @relation("ApprovedByAdmin")
  promotedUsers      User[]              @relation("PromotedByAdmin")
  projectAssignments ProjectAssignment[] @relation("AssignedByAdmin")
  uploadedDocuments  ProjectDocument[]
  generatedReports   GeneratedReport[]
  auditLogs          AuditLog[]

  @@map("admin_users")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

// =============================================
// USERS / APLICADORES
// =============================================
model User {
  id              String     @id @default(uuid())
  email           String     @unique
  passwordHash    String     @map("password_hash")
  name            String
  username        String     @unique
  phone           String?
  photoUrl        String?    @map("photo_url")

  // Approval workflow
  status          UserStatus @default(PENDING_APPROVAL)
  approvedAt      DateTime?  @map("approved_at")
  approvedById    String?    @map("approved_by")
  approvedBy      AdminUser? @relation("ApprovedByAdmin", fields: [approvedById], references: [id])
  rejectionReason String?    @map("rejection_reason")

  // Role/Position (managed by admin)
  role            UserRole   @default(AUXILIAR)
  promotedAt      DateTime?  @map("promoted_at")
  promotedById    String?    @map("promoted_by")
  promotedBy      AdminUser? @relation("PromotedByAdmin", fields: [promotedById], references: [id])

  // Gamification
  xpTotal         Int        @default(0) @map("xp_total")
  level           Int        @default(1)

  // Statistics (denormalized for performance)
  totalHoursWorked  Decimal  @default(0) @map("total_hours_worked") @db.Decimal(10, 2)
  totalM2Applied    Decimal  @default(0) @map("total_m2_applied") @db.Decimal(10, 2)
  totalProjectsCount Int     @default(0) @map("total_projects_count")

  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relations
  projectAssignments ProjectAssignment[]
  checkins           Checkin[]
  reports            Report[]
  auditLogs          AuditLog[]
  location           UserLocation?
  locationHistory    LocationHistory[]

  @@map("users")
}

enum UserStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SUSPENDED
}

enum UserRole {
  AUXILIAR
  APLICADOR
  APLICADOR_SENIOR
  LIDER_EQUIPE
}

// =============================================
// PROJECTS (Synced from Pipefy + local data)
// =============================================
model Project {
  id              String   @id @default(uuid())
  pipefyCardId    String?  @unique @map("pipefy_card_id")

  // Basic info (from Pipefy)
  title           String
  cliente         String?
  endereco        String?
  pipefyPhase     String?  @map("pipefy_phase") // Current phase from Pipefy

  // Measurements (from Pipefy)
  m2Total         Decimal  @default(0) @map("m2_total") @db.Decimal(10, 2)
  m2Piso          Decimal  @default(0) @map("m2_piso") @db.Decimal(10, 2)
  m2Parede        Decimal  @default(0) @map("m2_parede") @db.Decimal(10, 2)
  m2Teto          Decimal  @default(0) @map("m2_teto") @db.Decimal(10, 2)
  mRodape         Decimal  @default(0) @map("m_rodape") @db.Decimal(10, 2)

  // Additional Pipefy fields
  equipe          String?
  cor             String?
  andamento       String?
  consultor       String?
  material        String?
  detalhamento    String?
  especiais       String?
  linkEscopo      String?  @map("link_escopo")

  // Admin-managed fields
  status          ProjectStatus @default(EM_EXECUCAO)
  estimatedHours  Decimal?      @map("estimated_hours") @db.Decimal(10, 2)
  workedHours     Decimal       @default(0) @map("worked_hours") @db.Decimal(10, 2)
  workflowDescription String?   @map("workflow_description")

  // AI fields (future)
  aiDetailedTasks String?  @map("ai_detailed_tasks")
  aiTasksPrompt   String?  @map("ai_tasks_prompt")

  // Geolocation for check-in
  latitude        Decimal? @db.Decimal(10, 8)
  longitude       Decimal? @db.Decimal(11, 8)
  geofenceRadius  Int      @default(200) @map("geofence_radius") // meters

  // Timestamps
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  pipefySyncedAt  DateTime? @map("pipefy_synced_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  assignments       ProjectAssignment[]
  checkins          Checkin[]
  reports           Report[]
  documents         ProjectDocument[]
  generatedReports  GeneratedReport[]
  telegramConfig    TelegramConfig?
  activeLocations   UserLocation[]

  @@map("projects")
}

enum ProjectStatus {
  EM_EXECUCAO
  PAUSADO
  CONCLUIDO
  CANCELADO
}

// =============================================
// PROJECT ASSIGNMENTS (Many-to-Many: Users <-> Projects)
// =============================================
model ProjectAssignment {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId     String    @map("project_id")
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  assignedById  String?   @map("assigned_by")
  assignedBy    AdminUser? @relation("AssignedByAdmin", fields: [assignedById], references: [id])
  assignedAt    DateTime  @default(now()) @map("assigned_at")
  removedAt     DateTime? @map("removed_at")
  isActive      Boolean   @default(true) @map("is_active")

  // Role within this project
  projectRole   ProjectRole @default(APLICADOR) @map("project_role")

  @@unique([userId, projectId])
  @@map("project_assignments")
}

enum ProjectRole {
  APLICADOR
  LIDER
}

// =============================================
// CHECK-INS / CHECK-OUTS
// =============================================
model Checkin {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId       String    @map("project_id")
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  checkinAt       DateTime  @default(now()) @map("checkin_at")
  checkoutAt      DateTime? @map("checkout_at")

  // Location data
  checkinLatitude   Decimal?  @map("checkin_latitude") @db.Decimal(10, 8)
  checkinLongitude  Decimal?  @map("checkin_longitude") @db.Decimal(11, 8)
  checkoutLatitude  Decimal?  @map("checkout_latitude") @db.Decimal(10, 8)
  checkoutLongitude Decimal?  @map("checkout_longitude") @db.Decimal(11, 8)

  // Checkout reason
  checkoutReason  CheckoutReason? @map("checkout_reason")

  // Calculated hours
  hoursWorked     Decimal?  @map("hours_worked") @db.Decimal(10, 2)

  // Validation
  isValid         Boolean   @default(true) @map("is_valid")
  validationNotes String?   @map("validation_notes")

  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  reports         Report[]

  @@index([userId, checkinAt])
  @@index([projectId, checkinAt])
  @@map("checkins")
}

enum CheckoutReason {
  FIM_EXPEDIENTE
  OUTRO_PROJETO
  COMPRA_INSUMOS
}

// =============================================
// REPORTS (Audio + Photos from team)
// =============================================
model Report {
  id            String       @id @default(uuid())
  userId        String       @map("user_id")
  user          User         @relation(fields: [userId], references: [id])
  projectId     String       @map("project_id")
  project       Project      @relation(fields: [projectId], references: [id])
  checkinId     String?      @map("checkin_id")
  checkin       Checkin?     @relation(fields: [checkinId], references: [id])

  // Report type
  reportType    ReportType   @default(DAILY) @map("report_type")
  reportDate    DateTime     @default(now()) @map("report_date") @db.Date

  // Audio
  audioFileUrl        String?   @map("audio_file_url")
  audioDurationSeconds Int?     @map("audio_duration_seconds")

  // AI-processed content
  audioTranscription  String?   @map("audio_transcription")
  aiSummary           String?   @map("ai_summary")
  aiProcessedAt       DateTime? @map("ai_processed_at")

  // Quick tags selected
  tags          String[]

  // Notes
  notes         String?

  // Status
  status        ReportStatus @default(DRAFT)
  submittedAt   DateTime?    @map("submitted_at")

  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  photos        ReportPhoto[]

  @@index([projectId, reportDate])
  @@map("reports")
}

enum ReportType {
  DAILY
  PERIOD
  INCIDENT
}

enum ReportStatus {
  DRAFT
  SUBMITTED
  PROCESSED
}

// =============================================
// REPORT PHOTOS
// =============================================
model ReportPhoto {
  id          String   @id @default(uuid())
  reportId    String   @map("report_id")
  report      Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)

  fileUrl     String   @map("file_url")
  fileName    String?  @map("file_name")
  fileSize    Int?     @map("file_size")
  mimeType    String?  @map("mime_type")

  caption     String?
  takenAt     DateTime? @map("taken_at")

  sortOrder   Int      @default(0) @map("sort_order")

  createdAt   DateTime @default(now()) @map("created_at")

  @@map("report_photos")
}

// =============================================
// PROJECT DOCUMENTS (Uploaded by admin)
// =============================================
model ProjectDocument {
  id            String     @id @default(uuid())
  projectId     String     @map("project_id")
  project       Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedById  String?    @map("uploaded_by")
  uploadedBy    AdminUser? @relation(fields: [uploadedById], references: [id])

  fileUrl       String     @map("file_url")
  fileName      String     @map("file_name")
  fileSize      Int?       @map("file_size")
  mimeType      String?    @map("mime_type")

  documentType  DocumentType? @map("document_type")
  description   String?

  createdAt     DateTime   @default(now()) @map("created_at")

  @@map("project_documents")
}

enum DocumentType {
  ESCOPO
  PLANTA
  CONTRATO
  OUTROS
}

// =============================================
// GENERATED REPORTS (Admin-generated)
// =============================================
model GeneratedReport {
  id                  String     @id @default(uuid())
  projectId           String?    @map("project_id")
  project             Project?   @relation(fields: [projectId], references: [id])
  generatedByAdminId  String?    @map("generated_by_admin_id")
  generatedByAdmin    AdminUser? @relation(fields: [generatedByAdminId], references: [id])

  type          GeneratedReportType @default(DAILY)

  // Period for period reports
  periodStart   DateTime?  @map("period_start")
  periodEnd     DateTime?  @map("period_end")

  // Content
  title         String?
  content       Json
  aiSummary     String?    @map("ai_summary")

  // Source reports used to generate this
  sourceReportIds String[] @map("source_report_ids")

  // File export
  pdfUrl        String?    @map("pdf_url")

  createdAt     DateTime   @default(now()) @map("created_at")

  @@map("generated_reports")
}

enum GeneratedReportType {
  DAILY
  PERIOD
  CUSTOM
}

// =============================================
// TELEGRAM INTEGRATION (Future - prepared)
// =============================================
model TelegramConfig {
  id            String   @id @default(uuid())
  projectId     String   @unique @map("project_id")
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  chatId        String?  @map("chat_id")
  botToken      String?  @map("bot_token")
  isActive      Boolean  @default(false) @map("is_active")

  // Notification settings
  notifyCheckins      Boolean @default(true) @map("notify_checkins")
  notifyReports       Boolean @default(true) @map("notify_reports")
  notifyDailySummary  Boolean @default(true) @map("notify_daily_summary")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("telegram_config")
}

// =============================================
// USER LOCATION (Real-time tracking)
// =============================================
model UserLocation {
  id            String    @id @default(uuid())
  userId        String    @unique @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  latitude      Decimal   @db.Decimal(10, 8)
  longitude     Decimal   @db.Decimal(11, 8)
  accuracy      Decimal?  @db.Decimal(10, 2) // meters
  heading       Decimal?  @db.Decimal(5, 2)  // degrees
  speed         Decimal?  @db.Decimal(6, 2)  // m/s

  // Status
  isOnline      Boolean   @default(true) @map("is_online")
  batteryLevel  Int?      @map("battery_level") // percentage

  // Current project (if checked in)
  currentProjectId String? @map("current_project_id")
  currentProject   Project? @relation(fields: [currentProjectId], references: [id])

  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("user_locations")
}

// =============================================
// LOCATION HISTORY (Optional - for tracking routes)
// =============================================
model LocationHistory {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  latitude      Decimal   @db.Decimal(10, 8)
  longitude     Decimal   @db.Decimal(11, 8)
  accuracy      Decimal?  @db.Decimal(10, 2)

  projectId     String?   @map("project_id")

  recordedAt    DateTime  @default(now()) @map("recorded_at")

  @@index([userId, recordedAt])
  @@map("location_history")
}

// =============================================
// AUDIT LOG
// =============================================
model AuditLog {
  id            String     @id @default(uuid())

  // Who
  adminUserId   String?    @map("admin_user_id")
  adminUser     AdminUser? @relation(fields: [adminUserId], references: [id])
  userId        String?    @map("user_id")
  user          User?      @relation(fields: [userId], references: [id])

  // What
  action        String
  entityType    String?    @map("entity_type")
  entityId      String?    @map("entity_id")

  // Details
  oldValues     Json?      @map("old_values")
  newValues     Json?      @map("new_values")
  description   String?

  // When/Where
  ipAddress     String?    @map("ip_address")
  userAgent     String?    @map("user_agent")
  createdAt     DateTime   @default(now()) @map("created_at")

  @@map("audit_logs")
}
